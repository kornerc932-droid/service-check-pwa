<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Service Check ‚Äì v2.3 (Full + Mobile Fix)</title>
  <style>
    :root { --bg:#f5f7fa; --fg:#1f2a34; --muted:#6b7b8c; --accent:#3b5a78; --card:#ffffff; --line:#d9e0e7; --ok:#1b8e3e; --warn:#c0392b; }
    body.dark { --bg:#0f1419; --fg:#e6ecf2; --muted:#9db0c2; --accent:#6aa0d1; --card:#1b242d; --line:#2a3642; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;}
    header{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;}
    .title{display:flex;align-items:center;gap:8px}
    .title small{color:var(--muted);font-weight:500}
    .container{padding:16px;max-width:980px;margin:0 auto;padding-bottom:140px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .input{flex:1;min-width:220px;display:flex;flex-direction:column;gap:6px}
    .input label{font-size:12px;color:var(--muted)}
    .req label::after{content:" *";color:#c0392b}
    .input input, .input textarea, .input select{border:1px solid var(--line);border-radius:10px;padding:12px 14px;background:#fff;color:#111;font-size:16px}
    body.dark .input input, body.dark .input textarea, body.dark .input select{background:#0e1419;color:#e6ecf2;border-color:#2a3642}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .tile{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;cursor:pointer;display:flex;flex-direction:column;gap:8px}
    .tile:hover{outline:2px solid var(--accent);}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button.primary{background:var(--accent);border:none;color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;font-size:16px}
    button.ghost{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;cursor:pointer;font-size:16px}
    button.icon{padding:8px 10px}
    button[disabled]{opacity:0.5;cursor:not-allowed}
    .note{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .quickbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:var(--card);font-size:12px}
    .banner{border:1px solid var(--line);background:#fff3;padding:10px 12px;border-radius:10px}
    .banner.ok{border-color:#bfe6cc;background:#ecfff1;color:var(--ok)}
    .banner.warn{border-color:#f4c7c7;background:#fff0f0;color:var(--warn)}
    /* Status-Chips */
    .badge{display:flex;gap:8px;flex-wrap:wrap}
    .chip{appearance:none;border:1px solid var(--line);background:var(--card);padding:10px 14px;border-radius:999px;font-size:16px;cursor:pointer;user-select:none;touch-action:manipulation}
    .chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,90,120,.15);}
    /* Signaturen */
    .sig-pad{border:1px dashed var(--line); border-radius:8px; padding:8px}
    .sig-canvas{width:100%; height:160px; background:#fff; border:1px solid var(--line); border-radius:6px; touch-action: none;}
    .sig-tools{display:flex; gap:8px; margin-top:6px;}
    /* Tabellen */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid var(--line);padding:8px;text-align:left;font-size:13px}
    .table th{background:#f3f6fa}
    body.dark .table th{background:#18212a}
    /* Footer */
    .footer-actions{position:sticky;bottom:0;background:var(--bg);border-top:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;flex-wrap:wrap;z-index:15}
    @media (max-width: 420px){
      .row{flex-direction:column}
      .input{min-width:unset}
      .container{padding:10px; padding-bottom:160px;}
    }
    @supports (padding: max(0px)){
      .footer-actions{padding-bottom: max(12px, env(safe-area-inset-bottom));}
      .container{padding-bottom: max(140px, calc(env(safe-area-inset-bottom) + 80px));}
    }
    @media print{
      header, .toolbar, .footer-actions, .banner, .startOnly, .authOnly, .homeOnly, .specsOnly { display:none !important; }
      body{background:#fff;color:#000}
      .container{max-width:none;margin:0;padding:0}
      .card{break-inside:avoid;border:1px solid #999}
      .input input, .input textarea{border:1px solid #999}
      @page { size: A4 portrait; margin: 12mm; }
    }
    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:1000}
    .modal.open{display:flex}
    .modal-card{background:var(--card);border:1px solid var(--line);border-radius:12px;max-width:720px;width:92%;padding:12px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <button class="ghost icon" id="backBtn" title="Zur√ºck">‚¨ÖÔ∏è</button>
      <h1 id="appTitle">Service Check</h1>
      <small id="subtitle"></small>
    </div>
    <div class="toolbar">
      <button class="ghost icon" id="toggleTheme" title="Hell/Dunkel">üåó</button>
      <button class="ghost icon" id="settingsBtn" title="Einstellungen">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="container" id="content"></main>

  <!-- Einstellungen Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px 0;font-size:16px;">Einstellungen</h2>
        <button class="ghost icon" id="closeSettings">‚úñÔ∏è</button>
      </div>
      <div class="note" style="margin-bottom:8px">Pflichtfelder mit * ‚Äì erforderlich zum Drucken/Export.</div>
      <div id="settingsForm"></div>
      <div class="sep"></div>
      <h3 style="margin:6px 0 8px 0;font-size:14px;">Sicherheit</h3>
      <div class="row">
        <div class="input"><label>Buchhaltung-PIN (4-stellig)</label><input id="accPin" placeholder="****" inputmode="numeric" maxlength="4"></div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="ghost" id="saveAccPin">PIN setzen/√§ndern</button>
        </div>
      </div>
      <div class="sep"></div>
      <h3 style="margin:6px 0 8px 0;font-size:14px;">Zuletzt gel√∂scht</h3>
      <div id="trashList" class="list"></div>
      <div class="modal-actions">
        <button class="ghost danger" id="emptyTrash">Papierkorb leeren</button>
        <button class="ghost" id="settingsSave">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Speichern in... Modal -->
  <div class="modal" id="saveInModal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px 0;font-size:16px;">Protokoll speichern in‚Ä¶</h2>
        <button class="ghost icon" id="closeSaveIn">‚úñÔ∏è</button>
      </div>
      <div id="saveInBody"></div>
      <div class="modal-actions">
        <button class="ghost" id="saveInCancel">Abbrechen</button>
        <button class="primary" id="saveInConfirm">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Verlassen? Modal -->
  <div class="modal" id="leaveModal" aria-hidden="true">
    <div class="modal-card">
      <h2 style="margin:6px 0 12px 0;font-size:16px;">Entwurf speichern?</h2>
      <div class="note">Du verl√§sst ein begonnenes Protokoll.</div>
      <div class="modal-actions">
        <button class="ghost" id="leaveNo">Nein</button>
        <button class="primary" id="leaveYes">Ja</button>
      </div>
    </div>
  </div>

  <!-- Buchhaltung-Login Modal -->
  <div class="modal" id="accModal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px 0;font-size:16px;">Buchhaltung entsperren</h2>
        <button class="ghost icon" id="closeAcc">‚úñÔ∏è</button>
      </div>
      <div class="row">
        <div class="input"><label>PIN (4-stellig)</label><input id="accLoginPin" placeholder="****" inputmode="numeric" maxlength="4"></div>
      </div>
      <div class="modal-actions">
        <button class="ghost" id="accCancel">Abbrechen</button>
        <button class="primary" id="accUnlock">Entsperren</button>
      </div>
      <div class="note">Hinweis: Die PIN wird lokal auf diesem Ger√§t gespeichert.</div>
    </div>
  </div>

<script>
  /* ==== CONFIG & SECTION DEFINITIONS (RBG, FT, Other) ==== */
  const REQUIRED_HEADER_KEYS = ['projektnummer','projekt','betreiber','datum']; // nur diese vier
  const HEADER_FIELDS = [
    {key:'projektnummer', label:'Projektnummer'},
    {key:'projekt', label:'Projekt'},
    {key:'betreiber', label:'Betreiber'},
    {key:'anlagenteil', label:'Anlagenteil (optional)', optional:true},
    {key:'datum', label:'Datum (TT/MM/JJJJ)'},
    {key:'baujahr', label:'Baujahr'},
    {key:'durchfuehrender', label:'Durchf√ºhrender (optional)', optional:true},
    {key:'auftragsnummer', label:'Auftragsnummer (optional)', optional:true},
    {key:'kostenstelle', label:'Kostenstelle (optional)', optional:true},
    {key:'kundennr', label:'Kunden-Nr. (optional)', optional:true}
  ];

  const PROTOCOL_SECTIONS_RBG = [
    { id:'gasse', title:'Gasse / Ausr√ºstung', items:[
      {id:'schleifleitung', label:'Schleifleitung / Stromabnehmer', fields:[{type:'status'},{type:'note'}]},
      {id:'fahrschiene', label:'Fahrschiene (Befestigung/Tragbild)', fields:[{type:'status'},{type:'note'}]},
      {id:'oberfuehrung', label:'Obere F√ºhrungsschiene (Befestigung, Verbindungen)', fields:[{type:'status'},{type:'note'}]},
      {id:'puffer', label:'Puffer / Festanschl√§ge (Befestigung)', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'fahrwagen', title:'Fahrwagen / F√ºhrungsrollen / Laufr√§der', items:[
      {id:'fw_befestigung', label:'Fahrwerk ‚Äì Befestigung', fields:[{type:'status'},{type:'note'}]},
      {id:'fw_motor', label:'Fahrwerk ‚Äì Motor', fields:[{type:'status'},{type:'note'}]},
      {id:'fw_drehmomentstuetze', label:'Fahrwerk ‚Äì Drehmomentst√ºtze', fields:[{type:'status'},{type:'note'}]},
      {id:'fr_hl', label:'F√ºhrungsrolle Fahrwagen hinten links', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_hr', label:'F√ºhrungsrolle Fahrwagen hinten rechts', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_vl', label:'F√ºhrungsrolle Fahrwagen vorn links', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_vr', label:'F√ºhrungsrolle Fahrwagen vorn rechts', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'lr_angetrieben', label:'Laufrad angetrieben', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'note'}]},
      {id:'lr_nichtangetrieben', label:'Laufrad nicht angetrieben', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'note'}]}
    ]},
    { id:'hubwerk', title:'Hubwerk', items:[
      {id:'befestigungen_allg', label:'Befestigungen (allg.)', fields:[{type:'status'},{type:'note'}]},
      {id:'als_bremse', label:'Bremse ‚Äì Arbeitsluftspalt (nach Herstellervorgabe)', fields:[{type:'status'},{type:'measurement',label:'ALS',unit:'mm'},{type:'note'}]},
      {id:'oeldichtheit', label:'Dichtungen / √ñldichtheit', fields:[{type:'status'},{type:'note'}]},
      {id:'hubseil', label:'Hubseil ‚Äì Sichtpr√ºfung (ISO 4309), Ablegereife', fields:[{type:'status'},{type:'measurement',label:'Seildicke',unit:'mm'},{type:'note'}]},
      {id:'seiltrommel_rillung', label:'Seiltrommel ‚Äì Seilrillung kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'seiltrommel_lagerung', label:'Seiltrommel ‚Äì Lagerung nachschmieren', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_kopftraverse', label:'Seilumlenkrollen ‚Äì Kopftraverse (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_kopftraverse_vorne', label:'Seilumlenkrollen ‚Äì Kopftraverse vorne (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_hubrahmen', label:'Seilumlenkrollen ‚Äì Hubrahmen (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'energiekette', label:'Energiekette/Schleifleitung ‚Äì Besch√§digungen kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'energiekette_uebergaenge', label:'Energiekette/Schleifleitung ‚Äì √úberg√§nge kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'energiekette_festpunkte', label:'Energiekette/Schleifleitung ‚Äì Festpunkte Festsitz pr√ºfen', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'tisch_kette_antrieb', title:'Teleskoptisch / Kettensystem / Antrieb', items:[
      {id:'oberteilauflage', label:'Oberteilauflage', fields:[{type:'status'},{type:'note'}]},
      {id:'kurvenrollen', label:'Kurvenrollen', fields:[{type:'status'},{type:'note'}]},
      {id:'schleifleisten', label:'Schleifleisten (einstellen falls n√∂tig)', fields:[{type:'status'},{type:'note'}]},
      {id:'zahnstange', label:'Zahnstange / Rollen / Gleitleisten', fields:[{type:'status'},{type:'note'}]},
      {id:'stuetzrollen', label:'St√ºtzrollen', fields:[{type:'status'},{type:'note'}]},
      {id:'getriebe', label:'Getriebe', fields:[{type:'status'},{type:'note'}]},
      {id:'ketten', label:'Ketten ‚Äì nachspannen & schmieren', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'kettenspanner', label:'Kettenspanner', fields:[{type:'status'},{type:'note'}]},
      {id:'umlenkrollen_ketten', label:'Umlenkrollen / Kettenr√§der', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'kupplung', label:'Kupplung', fields:[{type:'status'},{type:'note'}]},
      {id:'gelenkwelle', label:'Gelenkwelle', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'wiederkehrende_pruefung', title:'Wiederkehrende Pr√ºfung (Sicherheit)', items:[
      {id:'notauskette', label:'Not-Aus-Kette inkl. Verriegelungen ‚Äì Funktionspr√ºfung', fields:[{type:'status'},{type:'note'}]},
      {id:'endpositionen', label:'Endpositionen Wartung/Semiautomatik anfahren', fields:[{type:'status'},{type:'note'}]},
      {id:'bremsweg', label:'Bremsweg (ohne Last, niedrige Geschwindigkeit)', fields:[{type:'status'},{type:'note'}]},
      {id:'fangsystem', label:'Fangsystem / Geschwindigkeitsbegrenzer / Gest√§nge', fields:[{type:'status'},{type:'note'}]},
      {id:'lastmesseinheit', label:'Lastmesseinheit (√úber-/Unterlast) ‚Äì Test', fields:[{type:'status'},{type:'note'}]},
      {id:'sensorik', label:'Sicherheitsrelevante Sensorik / Lichtschranken', fields:[{type:'status'},{type:'note'}]},
      {id:'pruefbuch', label:'Pr√ºfbuch vorhanden und Eintrag vorgenommen', fields:[{type:'status'},{type:'note'}]},
      {id:'bedenken', label:'Bedenken gegen weiteren Betrieb', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'maengelliste', title:'M√§ngelliste', items:[
      {id:'maengel', label:'M√§ngel / Beanstandungen (Freitext)', fields:[{type:'note'}]},
      {id:'schmierstoffe', label:'Wurden die Schmierstoffe zur Verf√ºgung gestellt?', fields:[{type:'yesno'}]}
    ]}
  ];

  const PROTOCOL_SECTIONS_FT = [
    { id:'antrieb', title:'Antriebsstation', items:[
      {id:'ft_motor', label:'Motor / Getriebe', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_gek', label:'Kettenspanner / Riemenspannung', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'ft_schutz', label:'Schutzabdeckungen', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'umlenk', title:'Umlenkstation', items:[
      {id:'ft_rollen', label:'Umlenkrollen / Lager', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'ft_festigkeit', label:'Befestigungen', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'strecke', title:'F√∂rderstrecke', items:[
      {id:'ft_bahnen', label:'Rollen / B√§nder / Ketten', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_sens', label:'Sensorik / Lichtschranken', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_kabel', label:'Energief√ºhrung / Kabel / √úberg√§nge', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'sicherheit', title:'Sicherheit', items:[
      {id:'ft_notaus', label:'Not-Aus / Verriegelungen', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_betrieb', label:'Bedenken gegen Betrieb', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'maengel', title:'M√§ngelliste', items:[
      {id:'ft_maengel', label:'M√§ngel / Beanstandungen (Freitext)', fields:[{type:'note'}]},
      {id:'ft_schmierstoffe', label:'Wurden die Schmierstoffe zur Verf√ºgung gestellt?', fields:[{type:'yesno'}]}
    ]}
  ];

  const PROTOCOLS = {
    rbg: { name: 'Regalbedienger√§t', specs: [
        {key:'mast', label:'Mast', type:'select', options:['Ein-Mast','Zwei-Mast']},
        {key:'teleskoptisch', label:'Teleskoptisch', type:'select', options:['einfach','doppelt']},
        {key:'nutzlast', label:'Nutzlast (kg)', type:'number'},
        {key:'hubhoehe', label:'max. Hubh√∂he (m)', type:'number'},
        {key:'fahrweg', label:'Fahrweg (m)', type:'number'}
      ], sections: PROTOCOL_SECTIONS_RBG },
    ft: { name: 'F√∂rdertechnik', specs: [
        {key:'system', label:'System', type:'select', options:['Rollenbahn','Gurtf√∂rderer','Kettenf√∂rderer','Heber','Drehtisch']},
        {key:'antrieb', label:'Antrieb', type:'select', options:['Motor / Getriebe','Direktantrieb']},
        {key:'spurbreite', label:'Spurbreite (mm)', type:'number'},
        {key:'geschwindigkeit', label:'F√∂rdergeschwindigkeit (m/s)', type:'number'}
      ], sections: PROTOCOL_SECTIONS_FT },
    other: { name: 'Andere Anlage', specs: [
        {key:'beschreibung', label:'Kurzbeschreibung', type:'text'},
        {key:'hersteller', label:'Hersteller (optional)', type:'text'}
      ], sections: [
        { id:'allg', title:'Allgemein', items:[
          {id:'all_bef', label:'Befestigungen', fields:[{type:'status'},{type:'note'}]},
          {id:'all_sens', label:'Sensorik', fields:[{type:'status'},{type:'note'}]}
        ]},
        { id:'sich', title:'Sicherheit', items:[
          {id:'all_not', label:'Not-Aus', fields:[{type:'status'},{type:'note'}]}
        ]},
        { id:'mgl', title:'M√§ngelliste', items:[
          {id:'all_m', label:'M√§ngel (Freitext)', fields:[{type:'note'}]}
        ]}
      ]}
  };

  /* ==== STORAGE/STATE/HELPERS ==== */
  function lsGet(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; } }
  function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  const LS_USER='serviceCheckUser';
  const LS_DRAFTS='serviceCheckDrafts';
  const LS_PROJECTS='serviceCheckProjects';
  const LS_TRASH='serviceCheckTrash';
  const LS_SEC='serviceCheckSecurity';
  const LS_MAT='serviceCheckMaterials';

  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return new Date().toISOString(); }

  let STATE = {
    user: null,
    header: {},
    specs: {},
    protocolType: null,
    items: {},
    signatures: {sig1:null, sig2:null},
    datum_ddmmyyyy: null,
    page: 'start',
    currentDraftId: null,
    dirty: false,
    accUnlocked: false,
    accAutoLockTimer: null
  };
  let saveTimer=null;

  const $ = (sel, el=document)=>el.querySelector(sel);
  const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
  const pad=(n)=>String(n).padStart(2,'0');
  const toDDMMYYYY=(d)=> pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();
  function normalizeDateInput(s){
    if(!s) return null; s=String(s).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-'); return pad(+d)+'/'+pad(+m)+'/'+y; }
    s=s.replace(/[.\-]/g,'/');
    const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(m){ return pad(+m[1])+'/'+pad(+m[2])+'/'+m[3]; }
    return null;
  }
  const validDate=(s)=> !!normalizeDateInput(s);

  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#1f2a34',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:'9999',fontSize:'13px'});
    document.body.appendChild(t); setTimeout(()=>t.remove(),1400);
  }

  function keyFor(type){ return 'serviceCheckDraft:last:'+type; }

  function saveStateAutosave(){
    localStorage.setItem(LS_USER, JSON.stringify(STATE.user||{}));
    const p = STATE.protocolType || 'default';
    localStorage.setItem(keyFor(p), JSON.stringify({
      header: STATE.header, specs: STATE.specs, items: STATE.items, signatures: STATE.signatures, datum_ddmmyyyy: STATE.datum_ddmmyyyy
    }));
  }
  function debounceAutosave(){ if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(()=>{ saveStateAutosave(); }, 300); STATE.dirty = true; }
  function loadAutosaveFor(type){
    try{
      const raw=localStorage.getItem(keyFor(type));
      if(raw){
        const obj=JSON.parse(raw);
        STATE.header=obj.header||{};
        STATE.specs=obj.specs||{};
        STATE.items=obj.items||{};
        STATE.signatures=obj.signatures||{sig1:null,sig2:null};
        STATE.datum_ddmmyyyy=obj.datum_ddmmyyyy||toDDMMYYYY(new Date());
      } else {
        STATE.header={}; STATE.items={}; STATE.specs={}; STATE.signatures={sig1:null,sig2:null};
        STATE.datum_ddmmyyyy=toDDMMYYYY(new Date()); STATE.header.datum = STATE.datum_ddmmyyyy;
      }
      STATE.dirty=false;
    }catch(e){}
  }

  /* ==== DRAFTS ==== */
  function listDrafts(){ return lsGet(LS_DRAFTS, []); }
  function saveDraftSnapshot(projectId){
    const drafts = listDrafts();
    const idx = drafts.findIndex(d=> d.id===STATE.currentDraftId);
    const data = {
      id: idx>=0 ? drafts[idx].id : uid(),
      projectId: projectId ?? (idx>=0 ? drafts[idx].projectId : null),
      title: buildDraftTitle(),
      protocolType: STATE.protocolType,
      header: STATE.header,
      specs: STATE.specs,
      items: STATE.items,
      signatures: STATE.signatures,
      datum_ddmmyyyy: STATE.datum_ddmmyyyy,
      updatedAt: now(),
      deletedAt: null
    };
    if(idx>=0) drafts[idx]=data; else drafts.push(data);
    lsSet(LS_DRAFTS, drafts);
    STATE.currentDraftId = data.id;
    STATE.dirty=false;
    toast('In Entw√ºrfe gespeichert.');
    return data.id;
  }
  function deleteDraft(id){
    const drafts=listDrafts();
    const idx=drafts.findIndex(d=>d.id===id);
    if(idx>=0){
      const trash = lsGet(LS_TRASH, []);
      drafts[idx].deletedAt = now();
      trash.unshift({type:'draft', when:now(), payload:drafts[idx]});
      if(trash.length>50) trash.pop();
      lsSet(LS_TRASH, trash);
      drafts.splice(idx,1);
      lsSet(LS_DRAFTS, drafts);
    }
  }
  function restoreFromTrash(index){
    const trash = lsGet(LS_TRASH, []);
    const entry = trash[index];
    if(!entry) return;
    if(entry.type==='draft'){
      const drafts = listDrafts();
      entry.payload.deletedAt = null;
      drafts.unshift(entry.payload);
      lsSet(LS_DRAFTS, drafts);
    } else if(entry.type==='project'){
      const projects = listProjects();
      entry.payload.deletedAt = null;
      projects.unshift(entry.payload);
      lsSet(LS_PROJECTS, projects);
    }
    trash.splice(index,1); lsSet(LS_TRASH, trash);
  }
  function emptyTrash(){ lsSet(LS_TRASH, []); }

  /* ==== PROJECTS & TIMES ==== */
  function listProjects(){ return lsGet(LS_PROJECTS, []); }
  function saveProject(p){
    const arr=listProjects();
    if(!p.id){ p.id=uid(); p.createdAt=now(); }
    const i=arr.findIndex(x=>x.id===p.id);
    if(i>=0) arr[i]=p; else arr.unshift(p);
    lsSet(LS_PROJECTS, arr);
    if(!localStorage.getItem('serviceCheckTimes:'+p.id)) lsSet('serviceCheckTimes:'+p.id, []);
    return p.id;
  }
  function deleteProject(id){
    const arr=listProjects();
    const i=arr.findIndex(x=>x.id===id);
    if(i>=0){
      const trash = lsGet(LS_TRASH, []);
      arr[i].deletedAt = now();
      trash.unshift({type:'project', when:now(), payload:arr[i]});
      if(trash.length>50) trash.pop();
      lsSet(LS_TRASH, trash);
      arr.splice(i,1); lsSet(LS_PROJECTS, arr);
    }
  }
  function listTimes(projectId){ return lsGet('serviceCheckTimes:'+projectId, []); }
  function addTime(projectId, t){ const arr=listTimes(projectId); t.id=uid(); t.createdAt=now(); arr.unshift(t); lsSet('serviceCheckTimes:'+projectId, arr); }

  /* ==== MATERIALS/LEISTUNGEN ==== */
  function listMaterials(){ return lsGet(LS_MAT, []); }
  function saveMaterial(m){ const arr=listMaterials(); if(!m.id){ m.id=uid(); m.createdAt=now(); } else { m.updatedAt=now(); }
    const i=arr.findIndex(x=>x.id===m.id); if(i>=0) arr[i]=m; else arr.unshift(m); lsSet(LS_MAT, arr); }
  function deleteMaterial(id){ const arr=listMaterials().filter(x=>x.id!==id); lsSet(LS_MAT, arr); }

  /* ==== NAV ==== */
  function setTitle(title, subtitle=''){ $('#appTitle').textContent = title || 'Service Check'; $('#subtitle').textContent = subtitle ? '¬∑ '+subtitle : ''; }
  function navigate(page){
    if(STATE.page==='protocol' && STATE.dirty){
      openLeaveModal(()=>{ saveDraftSnapshot(STATE._pendingSaveProjectId || null); STATE.dirty=false; STATE._pendingNav = page; closeLeaveModal(true); },
                      ()=>{ STATE.dirty=false; STATE._pendingNav = page; closeLeaveModal(true); });
      return;
    }
    STATE.page = page; render();
  }

  /* ==== RENDERERS ==== */
  function render(){
    const root = $('#content'); root.innerHTML='';
    $('#backBtn').style.display = (STATE.page==='start'||STATE.page==='home') ? 'none' : 'inline-flex';
    $('#settingsBtn').style.display = (['protocol','home','specs','projects','drafts','accounting','project'].includes(STATE.page)) ? 'inline-flex' : 'none';

    if(STATE.page==='start') return renderStart(root);
    if(STATE.page==='auth') return renderAuth(root);
    if(STATE.page==='home') return renderHome(root);
    if(STATE.page==='projects') return renderProjects(root);
    if(STATE.page==='project') return renderProjectDetail(root);
    if(STATE.page==='specs') return renderSpecs(root);
    if(STATE.page==='protocol') return renderProtocol(root);
    if(STATE.page==='drafts') return renderDrafts(root);
    if(STATE.page==='accounting') return renderAccounting(root);
  }

  function renderStart(root){
    setTitle('Service Check','Start');
    const card=document.createElement('section'); card.className='card';
    card.innerHTML=`
      <h2 style="margin:6px 0 12px 0;font-size:16px;">Willkommen</h2>
      <p>Diese App speichert Daten lokal (offline). F√ºr Team-Funktionen/Cloud sp√§ter.</p>
      <div class="row startOnly">
        <button class="primary" id="startAuth">Anmelden / Registrieren</button>
        <button class="ghost" id="skipToHome">Ohne Anmeldung fortfahren</button>
      </div>
    `;
    root.appendChild(card);
    $('#startAuth').onclick=()=>navigate('auth');
    $('#skipToHome').onclick=()=>{ if(!STATE.user){ STATE.user={name:'Gast'}; } navigate('home'); };
  }

  function renderAuth(root){
    setTitle('Service Check','Anmeldung');
    const card=document.createElement('section'); card.className='card';
    const name=STATE.user?.name||''; const email=STATE.user?.email||'';
    card.innerHTML=`
      <div class="row authOnly">
        <div class="input req"><label>Dein Name</label><input id="name" placeholder="Name" value="${name}"></div>
        <div class="input"><label>E-Mail (optional)</label><input id="email" placeholder="email@example.com" value="${email}"></div>
        <div class="input req"><label>PIN (4-stellig, lokal)</label><input id="pin" inputmode="numeric" maxlength="4" placeholder="****"></div>
      </div>
      <div class="note">Hinweis: Die Anmeldung ist <b>lokal</b> (nur auf diesem Ger√§t). Kein Server.</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="primary" id="doLogin">Weiter</button>
      </div>
    `;
    root.appendChild(card);
    $('#doLogin').onclick=()=>{
      const n=$('#name').value.trim(); const p=$('#pin').value.trim();
      if(!n || p.length!==4){ alert('Bitte Name und 4-stellige PIN eingeben.'); return; }
      STATE.user={name:n, email:$('#email').value.trim()||undefined, pin:p};
      localStorage.setItem(LS_USER, JSON.stringify(STATE.user));
      navigate('home');
    };
  }

  function renderHome(root){
    setTitle('Service Check','Hauptmen√º');
    const card=document.createElement('section'); card.className='card';
    card.innerHTML=`
      <div class="note homeOnly">Angemeldet als: <b>${STATE.user?.name||'Gast'}</b></div>
      <h2 style="margin:6px 0 12px 0;font-size:16px;">Was m√∂chtest du tun?</h2>
      <div class="grid" id="tiles"></div>
    `;
    root.appendChild(card);
    const grid=$('#tiles');
    const tNew=document.createElement('div'); tNew.className='tile'; tNew.innerHTML=`<div style="font-weight:600">Neues Protokoll</div><div class="note">RBG, F√∂rdertechnik oder anderes</div>`;
    tNew.onclick=()=>{ STATE.protocolType='rbg'; loadAutosaveFor('rbg'); navigate('specs'); };
    grid.appendChild(tNew);

    Object.entries(PROTOCOLS).forEach(([k,v])=>{
      const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<div style="font-weight:600">${v.name}</div><div class="note">Protokoll starten</div>`;
      t.onclick=()=>{ STATE.protocolType=k; loadAutosaveFor(k); navigate('specs'); };
      grid.appendChild(t);
    });

    const tDrafts=document.createElement('div'); tDrafts.className='tile'; tDrafts.innerHTML=`<div style="font-weight:600">Entw√ºrfe</div><div class="note">Sammelstelle der gespeicherten Protokolle</div>`;
    tDrafts.onclick=()=>navigate('drafts'); grid.appendChild(tDrafts);

    const tProjects=document.createElement('div'); tProjects.className='tile'; tProjects.innerHTML=`<div style="font-weight:600">Projekte</div><div class="note">Projektordner & Arbeitszeit-Protokolle</div>`;
    tProjects.onclick=()=>navigate('projects'); grid.appendChild(tProjects);

    const tAcc=document.createElement('div'); tAcc.className='tile'; tAcc.innerHTML=`<div style="font-weight:600">Buchhaltung ${STATE.accUnlocked?'(entsperrt)':'(üîí gesperrt)'}</div><div class="note">Material/Leistungen, Zeit-CSV, Exporte</div>`;
    tAcc.onclick=()=>{ if(!STATE.accUnlocked){ openAccModal(); } else { navigate('accounting'); } };
    grid.appendChild(tAcc);
  }

  function renderProjects(root){
    setTitle('Service Check','Projekte');
    const card=document.createElement('section'); card.className='card';
    card.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px 0;font-size:16px;">Projektordner</h2>
        <button class="primary" id="newProject">Neues Projekt</button>
      </div>
      <div id="projectList" class="list"></div>
    `;
    root.appendChild(card);
    $('#newProject').onclick=()=>{
      const pn = prompt('Projektnummer?')||'';
      const pj = prompt('Projektname?')||'';
      const bet = prompt('Betreiber?')||'';
      const bj = prompt('Baujahr?')||'';
      if(!pn.trim() || !pj.trim()) return;
      saveProject({projektnummer:pn.trim(), projekt:pj.trim(), betreiber:bet.trim(), baujahr:bj.trim()});
      toast('Projekt angelegt. Arbeitszeit-Protokoll erstellt.');
      render();
    };
    const list=$('#projectList');
    const projs=listProjects();
    if(!projs.length){ const p=document.createElement('div'); p.className='note'; p.textContent='Noch keine Projekte.'; list.appendChild(p); }
    projs.forEach(p=>{
      const item=document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center'; item.style.border='1px solid var(--line)'; item.style.borderRadius='10px'; item.style.padding='10px 12px'; item.style.margin='8px 0';
      const left=document.createElement('div');
      const t=document.createElement('div'); t.style.fontWeight='600'; t.style.marginBottom='2px'; t.textContent=`${p.projektnummer||'‚Äì'} ¬∑ ${p.projekt||''}`;
      const m=document.createElement('div'); m.className='meta'; m.style.fontSize='12px'; m.style.color='var(--muted)'; m.innerHTML=`<span>Betreiber: ${p.betreiber||'‚Äì'}</span> ¬∑ <span>Baujahr: ${p.baujahr||'‚Äì'}</span>`;
      left.appendChild(t); left.appendChild(m);
      const right=document.createElement('div');
      const open=document.createElement('button'); open.className='ghost'; open.textContent='√ñffnen';
      open.onclick=()=>{ STATE._projectOpenId=p.id; navigate('project'); };
      const del=document.createElement('button'); del.className='ghost danger'; del.textContent='L√∂schen';
      del.onclick=()=>{ if(confirm('Projekt l√∂schen?')){ deleteProject(p.id); render(); } };
      right.appendChild(open); right.appendChild(del);
      item.appendChild(left); item.appendChild(right);
      list.appendChild(item);
    });
  }

  function renderProjectDetail(root){
    const p=listProjects().find(x=>x.id===STATE._projectOpenId);
    if(!p){ navigate('projects'); return; }
    setTitle('Service Check', `Projekt: ${p.projektnummer||''}`);
    const head=document.createElement('section'); head.className='card';
    head.innerHTML=`
      <h2 style="margin:6px 0 12px 0;font-size:16px;">${p.projekt||'Projekt'}</h2>
      <div class="quickbar">
        <span class="pill">Projektnr: <b>${p.projektnummer||'‚Äì'}</b></span>
        <span class="pill">Betreiber: <b>${p.betreiber||'‚Äì'}</b></span>
        <span class="pill">Baujahr: <b>${p.baujahr||'‚Äì'}</b></span>
      </div>
    `;
    root.appendChild(head);

    const actions=document.createElement('section'); actions.className='card';
    actions.innerHTML=`
      <div class="grid">
        <div class="tile" id="startProto"><div style="font-weight:600">Protokoll im Projekt erstellen</div><div class="note">RBG/F√∂rdertechnik/Andere</div></div>
        <div class="tile" id="timeLog"><div style="font-weight:600">Arbeitszeit-Protokoll</div><div class="note">Zeiten erfassen & CSV-Export</div></div>
      </div>
    `;
    root.appendChild(actions);
    $('#startProto').onclick=()=>{ STATE.protocolType='rbg'; loadAutosaveFor('rbg'); STATE._saveToProjectId=p.id; navigate('specs'); };
    $('#timeLog').onclick=()=>{
      const card=document.createElement('section'); card.className='card';
      card.innerHTML = `<h3 style="margin:6px 0 12px 0;font-size:16px;">Arbeitszeit</h3>`;
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`
        <div class="input"><label>Datum</label><input id="tl_date" type="date"></div>
        <div class="input"><label>Mitarbeiter</label><input id="tl_name" placeholder="Name"></div>
        <div class="input"><label>T√§tigkeit</label><input id="tl_task" placeholder="z.B. Wartung RBG"></div>
        <div class="input"><label>Start (HH:MM)</label><input id="tl_start" placeholder="07:30"></div>
        <div class="input"><label>Ende (HH:MM)</label><input id="tl_end" placeholder="16:15"></div>
        <div class="input"><label>Pause (Min.)</label><input id="tl_break" type="number" placeholder="30"></div>
        <div class="input"><label>Kostenart (optional)</label><input id="tl_costtype" placeholder="z.B. Monteur"></div>
        <div class="input"><label>Kilometer (optional)</label><input id="tl_km" type="number" placeholder="0"></div>
      `;
      const btn=document.createElement('button'); btn.className='primary'; btn.textContent='Eintrag hinzuf√ºgen';
      btn.onclick=()=>{
        const d=$('#tl_date').value, n=$('#tl_name').value.trim(), t=$('#tl_task').value.trim();
        const s=$('#tl_start').value, e=$('#tl_end').value, b=parseInt($('#tl_break').value||'0',10)||0;
        if(!d||!n||!s||!e){ alert('Bitte Datum, Name, Start, Ende angeben.'); return; }
        addTime(p.id, {date:d, staff:n, task:t, start:s, end:e, breakMin:b, costtype:$('#tl_costtype').value.trim(), km:parseFloat($('#tl_km').value||'0')||0});
        render();
      };
      const wrap=document.createElement('div'); wrap.appendChild(row); wrap.appendChild(btn);
      card.appendChild(wrap);
      root.appendChild(card);

      const listCard=document.createElement('section'); listCard.className='card';
      listCard.innerHTML='<h3 style="margin:6px 0 12px 0;font-size:16px;">Eintr√§ge</h3>';
      const list=document.createElement('div'); list.className='list';
      const entries=listTimes(p.id);
      if(!entries.length){ const n=document.createElement('div'); n.className='note'; n.textContent='Noch keine Eintr√§ge.'; list.appendChild(n); }
      entries.forEach(en=>{
        const it=document.createElement('div'); it.style.display='flex'; it.style.justifyContent='space-between'; it.style.alignItems='center'; it.style.border='1px solid var(--line)'; it.style.borderRadius='10px'; it.style.padding='10px 12px'; it.style.margin='8px 0';
        const left=document.createElement('div');
        const title=document.createElement('div'); title.style.fontWeight='600'; title.textContent=`${en.date} ¬∑ ${en.staff}`;
        const meta=document.createElement('div'); meta.className='meta'; meta.style.fontSize='12px'; meta.style.color='var(--muted)'; meta.innerHTML=`${en.start}‚Äì${en.end}, Pause ${en.breakMin||0} min ¬∑ ${en.task||''} ${en.km?(' ¬∑ '+en.km+' km'):''}`;
        left.appendChild(title); left.appendChild(meta);
        const right=document.createElement('div');
        const del=document.createElement('button'); del.className='ghost danger'; del.textContent='Entfernen';
        del.onclick=()=>{
          const rest=listTimes(p.id).filter(x=>x.id!==en.id);
          lsSet('serviceCheckTimes:'+p.id, rest);
          render();
        };
        right.appendChild(del);
        it.appendChild(left); it.appendChild(right);
        list.appendChild(it);
      });
      const expBtn=document.createElement('button'); expBtn.className='ghost'; expBtn.textContent='CSV exportieren';
      expBtn.onclick=()=>{
        const e=listTimes(p.id);
        const headers=['Datum','Mitarbeiter','T√§tigkeit','Start','Ende','PauseMin','Kostenart','Kilometer','Projekt','Projektnummer','Betreiber'];
        const rows=e.map(x=>[x.date,x.staff,(x.task||''),(x.start||''),(x.end||''),(x.breakMin||0),(x.costtype||''),(x.km||0),(p.projekt||''),(p.projektnummer||''),(p.betreiber||'')]);
        const csv=[headers.join(';')].concat(rows.map(r=>r.map(val=>String(val).replace(/;/g,',')).join(';'))).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Arbeitszeit_${p.projektnummer||'Projekt'}.csv`; a.click(); URL.revokeObjectURL(url);
      };
      listCard.appendChild(list); listCard.appendChild(document.createElement('br')); listCard.appendChild(expBtn);
      root.appendChild(listCard);
    };
  }

  function renderSpecs(root){
    const proto = PROTOCOLS[STATE.protocolType];
    setTitle('Service Check', proto.name+' ¬∑ Spezifikation');
    const card=document.createElement('section'); card.className='card';
    const wrap=document.createElement('div'); wrap.className='row specsOnly';
    proto.specs.forEach(f=>{
      const box=document.createElement('div'); box.className='input';
      const lab=document.createElement('label'); lab.textContent=f.label;
      let field;
      if(f.type==='select'){
        field=document.createElement('select');
        field.innerHTML = '<option value="">‚Äì</option>' + f.options.map(o=>`<option>${o}</option>`).join('');
        field.value = STATE.specs[f.key] || '';
        field.onchange=()=>{ STATE.specs[f.key]=field.value; debounceAutosave(); };
      } else {
        field=document.createElement('input'); field.type=f.type||'text';
        field.value = STATE.specs[f.key]||'';
        field.oninput=()=>{ STATE.specs[f.key]=field.value; debounceAutosave(); };
      }
      box.append(lab, field); wrap.appendChild(box);
    });
    card.appendChild(wrap);
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
    const next=document.createElement('button'); next.className='primary'; next.textContent='Weiter zum Protokoll';
    next.onclick=()=>navigate('protocol');
    actions.appendChild(next);
    card.appendChild(actions);
    root.appendChild(card);
  }

  function renderDrafts(root){
    setTitle('Service Check', 'Entw√ºrfe');
    const card=document.createElement('section'); card.className='card';
    card.innerHTML=`<div class="list" id="draftList"></div>`;
    root.appendChild(card);
    const listEl=$('#draftList');
    const drafts=listDrafts();
    if(!drafts.length){ const n=document.createElement('div'); n.className='note'; n.textContent='Noch keine Entw√ºrfe gespeichert.'; listEl.appendChild(n); }
    drafts.sort((a,b)=> (b.updatedAt||'').localeCompare(a.updatedAt||''));
    const projects = listProjects();
    drafts.forEach(d=>{
      const proj = d.projectId ? projects.find(p=>p.id===d.projectId) : null;
      const it=document.createElement('div'); it.style.display='flex'; it.style.justifyContent='space-between'; it.style.alignItems='center'; it.style.border='1px solid var(--line)'; it.style.borderRadius='10px'; it.style.padding='10px 12px'; it.style.margin='8px 0';
      const left=document.createElement('div'); left.style.flex='1';
      const t=document.createElement('div'); t.style.fontWeight='600'; t.style.marginBottom='2px'; t.textContent=d.title||'Entwurf';
      const m=document.createElement('div'); m.className='meta'; m.style.fontSize='12px'; m.style.color='var(--muted)'; m.innerHTML=`${PROTOCOLS[d.protocolType]?.name||d.protocolType||'‚Äì'} ¬∑ ${d.updatedAt?new Date(d.updatedAt).toLocaleString():''}${proj?(' ¬∑ Projekt: '+(proj.projektnummer||'')+' '+(proj.projekt||'')):' '}`;
      left.appendChild(t); left.appendChild(m);
      const right=document.createElement('div');
      const open=document.createElement('button'); open.className='ghost'; open.textContent='√ñffnen';
      open.onclick=()=>{
        STATE.protocolType=d.protocolType; STATE.header=d.header||{}; STATE.specs=d.specs||{}; STATE.items=d.items||{}; STATE.signatures=d.signatures||{sig1:null,sig2:null};
        STATE.datum_ddmmyyyy=d.datum_ddmmyyyy||STATE.header.datum||toDDMMYYYY(new Date()); STATE.currentDraftId=d.id; STATE.dirty=false;
        navigate('protocol');
      };
      const del=document.createElement('button'); del.className='ghost danger'; del.textContent='L√∂schen';
      del.onclick=()=>{ if(confirm('Entwurf l√∂schen?')){ deleteDraft(d.id); render(); } };
      right.appendChild(open); right.appendChild(del);
      it.appendChild(left); it.appendChild(right);
      listEl.appendChild(it);
    });
  }

  function renderProtocol(root){
    const proto = PROTOCOLS[STATE.protocolType];
    setTitle('Service Check', proto.name+' ¬∑ Protokoll');

    const quick=document.createElement('section'); quick.className='card';
    quick.innerHTML = `
      <h2 style="margin:6px 0 12px 0;font-size:16px;">Wartungsprotokoll</h2>
      <div class="quickbar">
        <span class="pill">Projektnr: <b>${STATE.header.projektnummer||'‚Äì'}</b></span>
        <span class="pill">Projekt: <b>${STATE.header.projekt||'‚Äì'}</b></span>
        <span class="pill">Betreiber: <b>${STATE.header.betreiber||'‚Äì'}</b></span>
      </div>
    `;
    root.appendChild(quick);

    const infoCard=document.createElement('section'); infoCard.className='card';
    const ready = validateRequiredHeadersOnly();
    infoCard.innerHTML = `
      <div class="banner ${ready?'ok':'warn'}">
        ${ready ? 'Pflichtfelder in Einstellungen vollst√§ndig.' : 'Bitte Pflichtfelder in den Einstellungen ausf√ºllen, um Drucken/Export zu aktivieren.'}
      </div>
      <details style="margin-top:8px">
        <summary>‚ÑπÔ∏è Hinweise anzeigen/ausblenden</summary>
        <div class="details">
          <div class="note" style="margin-bottom:6px;">Links/Rechts = Ansicht vom Schaltschrank Richtung Hubrahmen</div>
          <div class="note">i.O. = in Ordnung ; n.i.O. = nicht in Ordnung ; n.v. = nicht vorhanden</div>
        </div>
      </details>
    `;
    root.appendChild(infoCard);

    const specCard=document.createElement('section'); specCard.className='card';
    specCard.innerHTML='<h2 style="margin:6px 0 12px 0;font-size:16px;">Spezifikation</h2>';
    const srow=document.createElement('div'); srow.className='row';
    PROTOCOLS[STATE.protocolType].specs.forEach(f=>{
      const val = STATE.specs[f.key] || '‚Äì';
      const div=document.createElement('div'); div.className='input'; div.innerHTML=`<label>${f.label}</label><input disabled value="${val}">`;
      srow.appendChild(div);
    });
    specCard.appendChild(srow);
    root.appendChild(specCard);

    const sectionsWrap=document.createElement('div'); sectionsWrap.id='sections';
    root.appendChild(sectionsWrap);
    renderSectionsInto(sectionsWrap, proto.sections);

    const sigCard=document.createElement('section'); sigCard.className='card';
    sigCard.innerHTML='<h2 style="margin:6px 0 12px 0;font-size:16px;">Unterschriften</h2>';
    const sigRow=document.createElement('div'); sigRow.className='row';
    sigRow.appendChild(signatureBlock('Pr√ºfer','sig1'));
    sigRow.appendChild(signatureBlock('Kunde','sig2'));
    const dateBox=document.createElement('div'); dateBox.className='input'; dateBox.innerHTML=`<label>Datum (TT/MM/JJJJ)</label><input id="sigDate" placeholder="TT/MM/JJJJ">`;
    sigRow.appendChild(dateBox);
    sigCard.appendChild(sigRow);
    root.appendChild(sigCard);
    const sd = $('#sigDate'); const nowFmt = toDDMMYYYY(new Date()); sd.value = STATE.header['datum_unterschrift'] || nowFmt;
    sd.oninput = ()=>{ const norm=normalizeDateInput(sd.value)||sd.value; sd.value=norm; STATE.header['datum_unterschrift'] = norm; debounceAutosave(); };

    const footer=document.createElement('div'); footer.className='footer-actions';
    footer.innerHTML=`
      <button class="ghost" id="save">In Entw√ºrfe</button>
      <button class="ghost" id="saveIn">Speichern in‚Ä¶</button>
      <button class="ghost" id="export">Export (JSON)</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        Import <input id="import" type="file" accept="application/json" style="display:none">
      </label>
      <span style="flex:1"></span>
      <button class="primary" id="print" ${ready?'':'disabled'}>Drucken / PDF</button>
    `;
    root.appendChild(footer);

    $('#save').onclick=()=>{ saveDraftSnapshot(null); };
    $('#saveIn').onclick=openSaveInModal;
    $('#export').onclick=()=>{
      const blob = new Blob([JSON.stringify({ header: STATE.header, specs: STATE.specs, items: STATE.items, protocolType: STATE.protocolType },null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='service_check_export.json'; a.click(); URL.revokeObjectURL(url);
    };
    $('#import').addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{ try{ const o=JSON.parse(r.result);
          STATE.header=o.header||STATE.header; STATE.specs=o.specs||STATE.specs; STATE.items=o.items||STATE.items; STATE.protocolType=o.protocolType||STATE.protocolType;
          saveStateAutosave(); render();
        }catch(err){ alert('Ung√ºltige JSON-Datei.'); } };
      r.readAsText(f);
    });
    $('#print').onclick=()=>{
      if(!validateRequiredHeadersOnly()){ alert('Bitte Pflichtfelder in den Einstellungen ausf√ºllen.'); return; }
      window.print();
    };

    window._updateFooterActions = ()=>{ $('#print').disabled = !validateRequiredHeadersOnly(); };

    window.onbeforeunload = (e)=>{
      if(STATE.dirty){
        e.preventDefault(); e.returnValue=''; return '';
      }
    };
  }

  function buildDraftTitle(){
    const t = PROTOCOLS[STATE.protocolType]?.name || 'Protokoll';
    const p = STATE.header?.projektnummer ? ' ¬∑ '+STATE.header.projektnummer : '';
    return `${t}${p} ‚Äì ${STATE.header?.datum || STATE.datum_ddmmyyyy || toDDMMYYYY(new Date())}`;
  }

  function signatureBlock(labelText,key){
    const wrap=document.createElement('div'); wrap.className='input sig-pad';
    const lab=document.createElement('label'); lab.textContent='Unterschrift '+labelText;
    const canvas=document.createElement('canvas'); canvas.id='cv_'+key; canvas.className='sig-canvas';
    const tools=document.createElement('div'); tools.className='sig-tools';
    const clear=document.createElement('button'); clear.className='ghost'; clear.textContent='L√∂schen';
    tools.appendChild(clear);
    wrap.append(lab, canvas, tools);
    setTimeout(()=>signaturePad(canvas.id, clear, key), 0);
    return wrap;
  }

  function renderSectionsInto(container, sections){
    sections.forEach(section=>{
      const card=document.createElement('section'); card.className='card';
      const details=document.createElement('details'); details.open=false;
      const summary=document.createElement('summary'); summary.textContent=section.title;
      details.appendChild(summary);

      section.items.forEach(item=>{
        const wrap=document.createElement('div'); wrap.className='details';
        const label=document.createElement('div'); label.textContent=item.label; label.style.marginBottom='6px'; label.style.fontWeight='500';
        const tools=document.createElement('div'); tools.className='row';

        const hasStatus = (item.fields||[]).some(f=>f.type==='status');
        if(hasStatus){
          const status=document.createElement('div'); status.className='badge';
          [{k:'io',t:'i.O.'},{k:'nio',t:'n.i.O.'},{k:'nv',t:'n.v.'}].forEach(opt=>{
            const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=opt.t;
            const cur=STATE.items[item.id]?.status; if(cur===opt.k) b.classList.add('active');
            const setActive=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].status=opt.k;
              $$('.chip',status).forEach(x=>x.classList.remove('active')); b.classList.add('active'); debounceAutosave(); };
            b.addEventListener('click', setActive, {passive:true});
            b.addEventListener('touchend', setActive, {passive:true});
            status.appendChild(b);
          });
          tools.appendChild(status);
        }

        (item.fields||[]).forEach(f=>{
          if(f.type==='note'){
            const w=document.createElement('div'); w.className='input'; w.style.minWidth='260px';
            const lab=document.createElement('label'); lab.textContent='Bemerkung';
            const ta=document.createElement('textarea'); ta.rows=2; ta.value=STATE.items[item.id]?.note||'';
            ta.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].note=ta.value; debounceAutosave(); };
            w.append(lab, ta); tools.appendChild(w);
          }
          if(f.type==='measurement'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent=f.label+' ('+f.unit+')';
            const inp=document.createElement('input'); inp.type='number'; inp.inputMode='decimal'; inp.value=STATE.items[item.id]?.[f.label]||'';
            inp.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id][f.label]=inp.value; debounceAutosave(); };
            w.append(lab, inp); tools.appendChild(w);
          }
          if(f.type==='yesno'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent='Ja/Nein';
            const sel=document.createElement('select'); sel.innerHTML='<option value="">‚Äì</option><option>Ja</option><option>Nein</option>';
            sel.value=STATE.items[item.id]?.yesno||'';
            sel.onchange=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].yesno=sel.value; debounceAutosave(); };
            w.append(lab, sel); tools.appendChild(w);
          }
          if(f.type==='date'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent=f.label;
            const inp=document.createElement('input'); inp.type='date'; inp.value=STATE.items[item.id]?.[f.label]||'';
            inp.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id][f.label]=inp.value; debounceAutosave(); };
            w.append(lab, inp); tools.appendChild(w);
          }
          if(f.type==='lubricated'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent='';
            const box=document.createElement('div'); box.className='checkbox'; box.style.display='flex'; box.style.alignItems='center'; box.style.gap='6px';
            const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!STATE.items[item.id]?.geschmiert;
            const span=document.createElement('span'); span.textContent='geschmiert';
            cb.onchange=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].geschmiert=cb.checked; debounceAutosave(); };
            box.append(cb, span); w.append(lab, box); tools.appendChild(w);
          }
        });

        // Foto optional
        const photoWrap=document.createElement('div'); photoWrap.className='input'; photoWrap.style.maxWidth='260px';
        const photoLab=document.createElement('label'); photoLab.textContent='Foto (optional)';
        const photo=document.createElement('input'); photo.type='file'; photo.accept='image/*;capture=camera';
        const preview=document.createElement('img'); preview.style.maxWidth='120px'; preview.style.border='1px solid var(--line)'; preview.style.borderRadius='6px'; preview.style.marginTop='6px';
        if(STATE.items[item.id]?.photo){ preview.src=STATE.items[item.id].photo; photoWrap.appendChild(preview); }
        photo.onchange=async ()=>{ const f=photo.files?.[0]; if(!f) return;
          const b64=await fileToScaledDataURL(f,1600,0.75); STATE.items[item.id]=STATE.items[item.id]||{};
          STATE.items[item.id].photo=b64; preview.src=b64; if(!preview.parentNode) photoWrap.appendChild(preview); debounceAutosave(); };
        photoWrap.append(photoLab, photo); tools.appendChild(photoWrap);

        wrap.append(label, tools);
        details.appendChild(wrap);
      });

      card.appendChild(details);
      container.appendChild(card);
    });
  }

  function fileToScaledDataURL(file, maxSide=1600, quality=0.75){
    return new Promise((resolve)=>{
      const r=new FileReader();
      r.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          let w=img.width,h=img.height;
          if(w>h && w>maxSide){ h=Math.round(h*maxSide/w); w=maxSide; }
          else if(h>maxSide){ w=Math.round(w*maxSide/h); h=maxSide; }
          const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
          const cx=cv.getContext('2d'); cx.drawImage(img,0,0,w,h);
          resolve(cv.toDataURL('image/jpeg', quality));
        };
        img.src=r.result;
      };
      r.readAsDataURL(file);
    });
  }

  function signaturePad(canvasId, clearBtn, key){
    const canvas=document.getElementById(canvasId);
    const ctx=canvas.getContext('2d');
    function resize(){
      const ratio=Math.max(window.devicePixelRatio||1,1);
      const rect=canvas.getBoundingClientRect();
      canvas.width=rect.width*ratio; canvas.height=rect.height*ratio;
      ctx.scale(ratio,ratio); ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#111';
      if(STATE.signatures[key]){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,rect.width,rect.height); img.src=STATE.signatures[key]; }
    }
    let drawing=false,lastX=0,lastY=0;
    function start(x,y){ drawing=true; lastX=x; lastY=y; }
    function move(x,y){ if(!drawing) return; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke(); lastX=x; lastY=y; }
    function end(){ drawing=false; STATE.signatures[key]=canvas.toDataURL('image/png'); debounceAutosave(); }
    function getPos(e){ const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
    window.addEventListener('resize',resize);
    resize();
    canvas.addEventListener('mousedown', e=>{const p=getPos(e); start(p.x,p.y);});
    canvas.addEventListener('mousemove', e=>{const p=getPos(e); move(p.x,p.y);});
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', e=>{const p=getPos(e); start(p.x,p.y); e.preventDefault();});
    canvas.addEventListener('touchmove', e=>{const p=getPos(e); move(p.x,p.y); e.preventDefault();});
    canvas.addEventListener('touchend', end);
    clearBtn.onclick=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); STATE.signatures[key]=null; debounceAutosave(); };
  }

  /* ==== SETTINGS ==== */
  function openSettings(){
    const box = $('#settingsForm'); box.innerHTML='';
    const row = document.createElement('div'); row.className='row';
    HEADER_FIELDS.forEach(f=>{
      const w=document.createElement('div'); w.className='input'+(REQUIRED_HEADER_KEYS.includes(f.key)?' req':'');
      const lab=document.createElement('label'); lab.textContent=f.label;
      const inp=document.createElement('input'); inp.placeholder=f.label;
      if(f.key==='datum'){
        inp.type='text'; inp.inputMode='numeric'; inp.maxLength=10; inp.placeholder='TT/MM/JJJJ';
        inp.value=STATE.header.datum||STATE.datum_ddmmyyyy||toDDMMYYYY(new Date());
        inp.oninput=()=>{
          const norm=normalizeDateInput(inp.value)||inp.value;
          inp.value=norm; STATE.header.datum=norm; STATE.datum_ddmmyyyy=norm; debounceAutosave(); maybeUpdateFooter();
        };
        inp.onblur=()=>{ if(!validDate(inp.value)) alert('Bitte Datum als TT/MM/JJJJ eingeben.'); };
      } else {
        inp.value=STATE.header[f.key]||'';
        inp.oninput=()=>{ STATE.header[f.key]=inp.value; debounceAutosave(); maybeUpdateFooter(); };
      }
      w.append(lab, inp); row.appendChild(w);
    });
    box.appendChild(row);

    // Security
    const accPinEl = $('#accPin');
    const sec = lsGet(LS_SEC, {});
    accPinEl.value = sec.accPin || '';

    $('#saveAccPin').onclick=()=>{
      const v = String(accPinEl.value||'').trim();
      if(v && v.length!==4){ alert('Bitte genau 4 Ziffern f√ºr die Buchhaltung-PIN.'); return; }
      const s = lsGet(LS_SEC, {}); s.accPin = v || undefined; lsSet(LS_SEC, s);
      toast(v ? 'Buchhaltung-PIN gesetzt.' : 'Buchhaltung-PIN entfernt.');
    };

    // Trash list
    const tEl = $('#trashList'); tEl.innerHTML='';
    const trash = lsGet(LS_TRASH, []);
    if(!trash.length){ const n=document.createElement('div'); n.className='note'; n.textContent='Leer.'; tEl.appendChild(n); }
    trash.forEach((tr,i)=>{
      const it=document.createElement('div'); it.style.display='flex'; it.style.justifyContent='space-between'; it.style.alignItems='center'; it.style.border='1px solid var(--line)'; it.style.borderRadius='10px'; it.style.padding='10px 12px'; it.style.margin='8px 0';
      const left=document.createElement('div'); left.innerHTML=`<div style="font-weight:600">${tr.type==='draft'?'Entwurf':'Projekt'}</div><div class="meta" style="font-size:12px;color:var(--muted)">${new Date(tr.when).toLocaleString()}</div>`;
      const right=document.createElement('div'); const rec=document.createElement('button'); rec.className='ghost'; rec.textContent='Wiederherstellen';
      rec.onclick=()=>{ restoreFromTrash(i); openSettings(); };
      it.appendChild(left); it.appendChild(rec); tEl.appendChild(it);
    });

    $('#settingsModal').classList.add('open');
    $('#settingsModal').setAttribute('aria-hidden','false');
  }
  function closeSettings(){
    $('#settingsModal').classList.remove('open');
    $('#settingsModal').setAttribute('aria-hidden','true');
  }
  function validateRequiredHeadersOnly(){
    for(const k of REQUIRED_HEADER_KEYS){
      const v = STATE.header[k];
      if(!v || !String(v).trim().length) return false;
      if(k==='datum' && !validDate(v)) return false;
    }
    return true;
  }
  function maybeUpdateFooter(){ if(typeof window._updateFooterActions==='function') window._updateFooterActions(); }

  /* ==== Save In Modal ==== */
  function openSaveInModal(){
    const body=$('#saveInBody'); body.innerHTML='';
    const projects=listProjects();
    const wrap=document.createElement('div'); wrap.className='row';
    const selBox=document.createElement('div'); selBox.className='input';
    selBox.innerHTML='<label>Projektordner</label>';
    const sel=document.createElement('select');
    sel.innerHTML='<option value="">‚Äì</option>'+projects.map(p=>`<option value="${p.id}">${p.projektnummer||''} ¬∑ ${p.projekt||''}</option>`).join('');
    sel.value=STATE._saveToProjectId||''; selBox.appendChild(sel);
    const newBox=document.createElement('div'); newBox.className='input'; newBox.innerHTML='<label>Neues Projekt (optional)</label><input id="newProjNum" placeholder="Projektnummer"><input id="newProjName" placeholder="Projektname"><input id="newProjBet" placeholder="Betreiber"><input id="newProjBj" placeholder="Baujahr">';
    wrap.appendChild(selBox); wrap.appendChild(newBox); body.appendChild(wrap);
    $('#saveInModal').classList.add('open'); $('#saveInModal').setAttribute('aria-hidden','false');
    $('#saveInConfirm').onclick=()=>{
      let pid = sel.value || null;
      if(!pid){
        const pn=$('#newProjNum').value.trim(), pj=$('#newProjName').value.trim();
        if(pn && pj){ pid = saveProject({projektnummer:pn, projekt:pj, betreiber:$('#newProjBet').value.trim(), baujahr:$('#newProjBj').value.trim()}); toast('Projektordner erstellt.'); }
      }
      const id = saveDraftSnapshot(pid);
      STATE._saveToProjectId = pid;
      closeSaveInModal();
    };
    $('#saveInCancel').onclick=closeSaveInModal;
    $('#closeSaveIn').onclick=closeSaveInModal;
  }
  function closeSaveInModal(){
    $('#saveInModal').classList.remove('open'); $('#saveInModal').setAttribute('aria-hidden','true');
  }

  /* ==== Leave Modal ==== */
  function openLeaveModal(onYes,onNo){
    $('#leaveModal').classList.add('open'); $('#leaveModal').setAttribute('aria-hidden','false');
    $('#leaveYes').onclick=onYes||(()=>{});
    $('#leaveNo').onclick=onNo||(()=>{});
  }
  function closeLeaveModal(){
    $('#leaveModal').classList.remove('open'); $('#leaveModal').setAttribute('aria-hidden','true');
    if(STATE._pendingNav){ const p=STATE._pendingNav; STATE._pendingNav=null; navigate(p); }
  }

  /* ==== Accounting Access ==== */
  function openAccModal(){ $('#accModal').classList.add('open'); $('#accModal').setAttribute('aria-hidden','false'); }
  function closeAccModal(){ $('#accModal').classList.remove('open'); $('#accModal').setAttribute('aria-hidden','true'); }
  function unlockAccounting(){
    const sec = lsGet(LS_SEC, {});
    const pin = String($('#accLoginPin').value||'');
    if(!sec.accPin){ alert('Keine Buchhaltung-PIN gesetzt. Lege zuerst eine PIN in den Einstellungen fest.'); return; }
    if(pin!==String(sec.accPin)){ alert('Falsche PIN.'); return; }
    STATE.accUnlocked=true;
    scheduleAutoLock();
    closeAccModal();
    navigate('accounting');
  }
  function lockAccounting(){
    STATE.accUnlocked=false;
    if(STATE.accAutoLockTimer){ clearTimeout(STATE.accAutoLockTimer); STATE.accAutoLockTimer=null; }
    toast('Buchhaltung gesperrt.');
    navigate('home');
  }
  function scheduleAutoLock(){
    if(STATE.accAutoLockTimer) clearTimeout(STATE.accAutoLockTimer);
    STATE.accAutoLockTimer = setTimeout(()=>{ STATE.accUnlocked=false; toast('Buchhaltung automatisch gesperrt.'); if(STATE.page==='accounting'){ navigate('home'); } }, 5*60*1000);
  }

  /* ==== Accounting Page ==== */
  function renderAccounting(root){
    setTitle('Service Check','Buchhaltung');
    if(!STATE.accUnlocked){
      const card=document.createElement('section'); card.className='card';
      card.innerHTML='<div class="note">Buchhaltung ist gesperrt. Bitte √ºber die Startseite entsperren.</div>';
      root.appendChild(card);
      return;
    }

    const head=document.createElement('section'); head.className='card';
    head.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px 0;font-size:16px;">Buchhaltung ‚Äì √úbersicht</h2>
        <div style="display:flex;gap:8px">
          <button class="ghost" id="accRelock">Sperren</button>
        </div>
      </div>
      <div class="note">Auto-Sperre nach 5 Minuten Inaktivit√§t.</div>
    `;
    root.appendChild(head);
    $('#accRelock').onclick=lockAccounting;

    const matCard=document.createElement('section'); matCard.className='card';
    matCard.innerHTML='<h3 style="margin:6px 0 12px 0;font-size:15px;">Material / Leistungen erfassen</h3>';
    const row=document.createElement('div'); row.className='row';
    const projs=listProjects();
    const projSel=document.createElement('select'); projSel.innerHTML='<option value="">Projekt w√§hlen‚Ä¶</option>'+projs.map(p=>`<option value="${p.id}">${p.projektnummer||''} ¬∑ ${p.projekt||''}</option>`).join('');
    const f=(l,h='text')=>{ const d=document.createElement('div'); d.className='input'; const lab=document.createElement('label'); lab.textContent=l; const inp=document.createElement('input'); inp.type=h; d.append(lab, inp); return {wrap:d, input:inp}; };
    const fDatum=f('Datum','date');
    const fArtNr=f('Artikel-Nr.');
    const fBez=f('Bezeichnung');
    const fMenge=f('Menge','number');
    const fEinheit=f('Einheit');
    const fPreis=f('Einzelpreis netto (‚Ç¨)','number');
    const fUst=f('USt-Satz (%)','number'); fUst.input.value='19';
    const fKst=f('Kostenstelle (optional)');
    const fProj={wrap:document.createElement('div'), input:projSel}; fProj.wrap.className='input'; const labP=document.createElement('label'); labP.textContent='Projektordner'; fProj.wrap.append(labP, projSel);
    row.append(fProj.wrap,fDatum.wrap,fArtNr.wrap,fBez.wrap,fMenge.wrap,fEinheit.wrap,fPreis.wrap,fUst.wrap,fKst.wrap);
    const addBtn=document.createElement('button'); addBtn.className='primary'; addBtn.textContent='Eintrag hinzuf√ºgen';
    addBtn.onclick=()=>{
      if(!projSel.value){ alert('Bitte Projektordner w√§hlen.'); return; }
      if(!fBez.input.value.trim()){ alert('Bezeichnung angeben.'); return; }
      const m={ projectId: projSel.value, date: fDatum.input.value||new Date().toISOString().slice(0,10), artnr: fArtNr.input.value.trim(), name: fBez.input.value.trim(),
        qty: parseFloat(fMenge.input.value||'1')||1, unit: fEinheit.input.value.trim()||'Stk', priceNet: parseFloat(fPreis.input.value||'0')||0, vat: parseFloat(fUst.input.value||'0')||0, kst: fKst.input.value.trim()||'' };
      saveMaterial(m);
      render();
    };
    matCard.appendChild(row); matCard.appendChild(addBtn);
    root.appendChild(matCard);

    const tableCard=document.createElement('section'); tableCard.className='card';
    tableCard.innerHTML='<h3 style="margin:6px 0 12px 0;font-size:15px;">Erfasste Positionen</h3>';
    const tbl=document.createElement('table'); tbl.className='table';
    tbl.innerHTML = '<thead><tr><th>Datum</th><th>Projekt</th><th>Art.-Nr.</th><th>Bezeichnung</th><th>Menge</th><th>Einheit</th><th>Einzelpreis</th><th>USt%</th><th>Netto</th><th>USt</th><th>Brutto</th><th></th></tr></thead>';
    const tbody=document.createElement('tbody');
    const mats=listMaterials();
    const projsById=Object.fromEntries(listProjects().map(p=>[p.id,p]));
    let sumNet=0,sumVat=0,sumBrut=0;
    mats.forEach(m=>{
      const p=projsById[m.projectId];
      const net=(m.qty||0)*(m.priceNet||0);
      const vv=net*(m.vat||0)/100;
      const brut=net+vv;
      sumNet+=net; sumVat+=vv; sumBrut+=brut;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${m.date||''}</td>
        <td>${p ? (p.projektnummer||'')+' ¬∑ '+(p.projekt||'') : '‚Äì'}</td>
        <td>${m.artnr||''}</td><td>${m.name||''}</td><td>${m.qty||0}</td><td>${m.unit||''}</td>
        <td>${(m.priceNet||0).toFixed(2)}</td><td>${(m.vat||0).toFixed(0)}</td>
        <td>${net.toFixed(2)}</td><td>${vv.toFixed(2)}</td><td>${brut.toFixed(2)}</td>`;
      const td=document.createElement('td');
      const del=document.createElement('button'); del.className='ghost danger'; del.textContent='‚úñ';
      del.onclick=()=>{ if(confirm('Eintrag l√∂schen?')){ deleteMaterial(m.id); render(); } };
      td.appendChild(del); tr.appendChild(td);
      tbody.appendChild(tr);
    });
    const trSum=document.createElement('tr');
    trSum.innerHTML=`<td colspan="8" style="text-align:right;font-weight:600">Summe</td>
      <td style="font-weight:600">${sumNet.toFixed(2)}</td>
      <td style="font-weight:600">${sumVat.toFixed(2)}</td>
      <td style="font-weight:600">${sumBrut.toFixed(2)}</td>
      <td></td>`;
    tbody.appendChild(trSum);
    tbl.appendChild(tbody);
    tableCard.appendChild(tbl);

    const ex=document.createElement('div'); ex.style.display='flex'; ex.style.gap='8px'; ex.style.marginTop='10px';
    const expCsv=document.createElement('button'); expCsv.className='ghost'; expCsv.textContent='CSV exportieren (Material/Leistungen)';
    expCsv.onclick=()=>{
      const mats=listMaterials();
      const pmap=Object.fromEntries(listProjects().map(p=>[p.id,p]));
      const headers=['Datum','Projektnummer','Projekt','Betreiber','Art.-Nr.','Bezeichnung','Menge','Einheit','Einzelpreis_netto','USt_%','Netto','USt','Brutto','Kostenstelle'];
      const rows=mats.map(m=>{
        const p=pmap[m.projectId];
        const net=(m.qty||0)*(m.priceNet||0); const vv=net*(m.vat||0)/100; const brut=net+vv;
        return [m.date||'', p?.projektnummer||'', p?.projekt||'', p?.betreiber||'', m.artnr||'', m.name||'', m.qty||0, m.unit||'', (m.priceNet||0).toFixed(2), (m.vat||0).toFixed(0), net.toFixed(2), vv.toFixed(2), brut.toFixed(2), m.kst||''];
      });
      const csv=[headers.join(';')].concat(rows.map(r=>r.map(val=>String(val).replace(/;/g,',')).join(';'))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='Buchhaltung_Material_Leistungen.csv'; a.click(); URL.revokeObjectURL(url);
    };
    const lockBtn=document.createElement('button'); lockBtn.className='ghost danger'; lockBtn.textContent='Buchhaltung sperren';
    lockBtn.onclick=lockAccounting;
    ex.appendChild(expCsv); ex.appendChild(lockBtn);
    tableCard.appendChild(ex);
    root.appendChild(tableCard);
  }

  /* ==== INIT ==== */
  window.addEventListener('DOMContentLoaded', ()=>{
    document.body.classList.toggle('dark', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    try{ STATE.user=JSON.parse(localStorage.getItem(LS_USER)||'null')||null; }catch(e){}
    STATE.protocolType='rbg';
    loadAutosaveFor('rbg');
    STATE.page = STATE.user ? 'home' : 'start';
    render();

    $('#toggleTheme').onclick=()=>document.body.classList.toggle('dark');
    $('#settingsBtn').onclick=openSettings;
    $('#closeSettings').onclick=closeSettings;
    $('#emptyTrash').onclick=()=>{ if(confirm('Papierkorb wirklich leeren?')){ emptyTrash(); openSettings(); } };
    $('#settingsSave').onclick=()=>{ saveStateAutosave(); closeSettings(); maybeUpdateFooter(); };

    $('#backBtn').onclick=()=>{
      if(STATE.page==='auth'){ navigate('start'); return; }
      if(STATE.page==='home'){ navigate('start'); return; }
      if(STATE.page==='specs'){ navigate('home'); return; }
      if(STATE.page==='protocol'){ navigate('specs'); return; }
      if(STATE.page==='projects'){ navigate('home'); return; }
      if(STATE.page==='project'){ navigate('projects'); return; }
      if(STATE.page==='drafts'){ navigate('home'); return; }
      if(STATE.page==='accounting'){ navigate('home'); return; }
      navigate('start');
    };

    $('#accCancel').onclick=closeAccModal;
    $('#closeAcc').onclick=closeAccModal;
    $('#accUnlock').onclick=unlockAccounting;
  });
</script>
</body>
</html>
