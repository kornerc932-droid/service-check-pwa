<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Service Check ‚Äì v2.2 (Mobile Fix + Auswahl)</title>
  <style>
    :root { --bg:#f5f7fa; --fg:#1f2a34; --muted:#6b7b8c; --accent:#3b5a78; --card:#ffffff; --line:#d9e0e7; --ok:#1b8e3e; --warn:#c0392b; }
    body.dark { --bg:#0f1419; --fg:#e6ecf2; --muted:#9db0c2; --accent:#6aa0d1; --card:#1b242d; --line:#2a3642; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;}
    header{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;}
    .title{display:flex;align-items:center;gap:8px}
    .title small{color:var(--muted);font-weight:500}
    .container{padding:16px;max-width:980px;margin:0 auto;padding-bottom:140px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .input{flex:1;min-width:220px;display:flex;flex-direction:column;gap:6px}
    .input label{font-size:12px;color:var(--muted)}
    .req label::after{content:" *";color:#c0392b}
    .input input, .input textarea, .input select{border:1px solid var(--line);border-radius:10px;padding:12px 14px;background:#fff;color:#111;font-size:16px}
    body.dark .input input, body.dark .input textarea, body.dark .input select{background:#0e1419;color:#e6ecf2;border-color:#2a3642}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button.primary{background:var(--accent);border:none;color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;font-size:16px}
    button.ghost{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;cursor:pointer;font-size:16px}
    button.icon{padding:8px 10px}
    button[disabled]{opacity:0.5;cursor:not-allowed}
    .banner{border:1px solid var(--line);background:#fff3;padding:10px 12px;border-radius:10px}
    .banner.ok{border-color:#bfe6cc;background:#ecfff1;color:var(--ok)}
    .banner.warn{border-color:#f4c7c7;background:#fff0f0;color:var(--warn)}
    /* Status-Chips */
    .badge{display:flex;gap:8px;flex-wrap:wrap}
    .chip{appearance:none;border:1px solid var(--line);background:var(--card);padding:10px 14px;border-radius:999px;font-size:16px;cursor:pointer;user-select:none;touch-action:manipulation}
    .chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,90,120,.15);}
    /* Footer */
    .footer-actions{position:sticky;bottom:0;background:var(--bg);border-top:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;flex-wrap:wrap;z-index:15}
    @media (max-width: 420px){
      .row{flex-direction:column}
      .input{min-width:unset}
      .container{padding:10px; padding-bottom:160px;}
      .footer-actions{position:fixed;left:0;right:0}
      header{position:fixed;left:0;right:0}
      body{padding-top:60px;}
    }
    @supports (padding: max(0px)){
      .footer-actions{padding-bottom: max(12px, env(safe-area-inset-bottom));}
      .container{padding-bottom: max(140px, calc(env(safe-area-inset-bottom) + 80px));}
    }
    @media print{
      header, .toolbar, .footer-actions, .banner { display:none !important; }
      body{background:#fff;color:#000}
      .container{max-width:none;margin:0;padding:0}
      .card{break-inside:avoid;border:1px solid #999}
      .input input, .input textarea{border:1px solid #999}
      @page { size: A4 portrait; margin: 12mm; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <button class="ghost icon" id="backBtn" title="Nach oben">‚¨ÜÔ∏è</button>
      <h1 id="appTitle">Service Check</h1>
      <small id="subtitle"></small>
    </div>
    <div class="toolbar">
      <button class="ghost icon" id="toggleTheme" title="Hell/Dunkel">üåó</button>
    </div>
  </header>

  <main class="container" id="content"></main>

  <script>
  /* ---------------- Basiskonfig ---------------- */
  const REQUIRED_HEADER_KEYS = ['projektnummer','projekt','betreiber','datum']; // nur diese vier!
  const HEADER_FIELDS = [
    {key:'projektnummer', label:'Projektnummer'},
    {key:'projekt', label:'Projekt'},
    {key:'betreiber', label:'Betreiber'},
    {key:'datum', label:'Datum (TT/MM/JJJJ)'},
    {key:'baujahr', label:'Baujahr'},
    {key:'durchfuehrender', label:'Durchf√ºhrender (optional)', optional:true},
    {key:'anlagenteil', label:'Anlagenteil (optional)', optional:true},
  ];

  const PROTOCOL_SECTIONS_RBG = [
    { id:'gasse', title:'Gasse / Ausr√ºstung', items:[
      {id:'schleifleitung', label:'Schleifleitung / Stromabnehmer', fields:[{type:'status'},{type:'note'}]},
      {id:'fahrschiene', label:'Fahrschiene (Befestigung/Tragbild)', fields:[{type:'status'},{type:'note'}]},
      {id:'oberfuehrung', label:'Obere F√ºhrungsschiene (Befestigung, Verbindungen)', fields:[{type:'status'},{type:'note'}]},
      {id:'puffer', label:'Puffer / Festanschl√§ge (Befestigung)', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'fahrwagen', title:'Fahrwagen / F√ºhrungsrollen / Laufr√§der', items:[
      {id:'fw_befestigung', label:'Fahrwerk ‚Äì Befestigung', fields:[{type:'status'},{type:'note'}]},
      {id:'fw_motor', label:'Fahrwerk ‚Äì Motor', fields:[{type:'status'},{type:'note'}]},
      {id:'fw_drehmomentstuetze', label:'Fahrwerk ‚Äì Drehmomentst√ºtze', fields:[{type:'status'},{type:'note'}]},
      {id:'fr_hl', label:'F√ºhrungsrolle Fahrwagen hinten links', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_hr', label:'F√ºhrungsrolle Fahrwagen hinten rechts', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_vl', label:'F√ºhrungsrolle Fahrwagen vorn links', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_vr', label:'F√ºhrungsrolle Fahrwagen vorn rechts', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'lr_angetrieben', label:'Laufrad angetrieben', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'note'}]},
      {id:'lr_nichtangetrieben', label:'Laufrad nicht angetrieben', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'note'}]}
    ]},
    { id:'hubwerk', title:'Hubwerk', items:[
      {id:'befestigungen_allg', label:'Befestigungen (allg.)', fields:[{type:'status'},{type:'note'}]},
      {id:'als_bremse', label:'Bremse ‚Äì Arbeitsluftspalt (nach Herstellervorgabe)', fields:[{type:'status'},{type:'measurement',label:'ALS',unit:'mm'},{type:'note'}]},
      {id:'oeldichtheit', label:'Dichtungen / √ñldichtheit', fields:[{type:'status'},{type:'note'}]},
      {id:'hubseil', label:'Hubseil ‚Äì Sichtpr√ºfung (ISO 4309), Ablegereife', fields:[{type:'status'},{type:'measurement',label:'Seildicke',unit:'mm'},{type:'note'}]},
      {id:'seiltrommel_rillung', label:'Seiltrommel ‚Äì Seilrillung kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'seiltrommel_lagerung', label:'Seiltrommel ‚Äì Lagerung nachschmieren', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_kopftraverse', label:'Seilumlenkrollen ‚Äì Kopftraverse (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_kopftraverse_vorne', label:'Seilumlenkrollen ‚Äì Kopftraverse vorne (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_hubrahmen', label:'Seilumlenkrollen ‚Äì Hubrahmen (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'energiekette', label:'Energiekette/Schleifleitung ‚Äì Besch√§digungen kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'energiekette_uebergaenge', label:'Energiekette/Schleifleitung ‚Äì √úberg√§nge kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'energiekette_festpunkte', label:'Energiekette/Schleifleitung ‚Äì Festpunkte Festsitz pr√ºfen', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'tisch_kette_antrieb', title:'Teleskoptisch / Kettensystem / Antrieb', items:[
      {id:'oberteilauflage', label:'Oberteilauflage', fields:[{type:'status'},{type:'note'}]},
      {id:'kurvenrollen', label:'Kurvenrollen', fields:[{type:'status'},{type:'note'}]},
      {id:'schleifleisten', label:'Schleifleisten (einstellen falls n√∂tig)', fields:[{type:'status'},{type:'note'}]},
      {id:'zahnstange', label:'Zahnstange / Rollen / Gleitleisten', fields:[{type:'status'},{type:'note'}]},
      {id:'stuetzrollen', label:'St√ºtzrollen', fields:[{type:'status'},{type:'note'}]},
      {id:'getriebe', label:'Getriebe', fields:[{type:'status'},{type:'note'}]},
      {id:'ketten', label:'Ketten ‚Äì nachspannen & schmieren', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'kettenspanner', label:'Kettenspanner', fields:[{type:'status'},{type:'note'}]},
      {id:'umlenkrollen_ketten', label:'Umlenkrollen / Kettenr√§der', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'kupplung', label:'Kupplung', fields:[{type:'status'},{type:'note'}]},
      {id:'gelenkwelle', label:'Gelenkwelle', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'wiederkehrende_pruefung', title:'Wiederkehrende Pr√ºfung (Sicherheit)', items:[
      {id:'notauskette', label:'Not-Aus-Kette inkl. Verriegelungen ‚Äì Funktionspr√ºfung', fields:[{type:'status'},{type:'note'}]},
      {id:'endpositionen', label:'Endpositionen Wartung/Semiautomatik anfahren', fields:[{type:'status'},{type:'note'}]},
      {id:'bremsweg', label:'Bremsweg (ohne Last, niedrige Geschwindigkeit)', fields:[{type:'status'},{type:'note'}]},
      {id:'fangsystem', label:'Fangsystem / Geschwindigkeitsbegrenzer / Gest√§nge', fields:[{type:'status'},{type:'note'}]},
      {id:'lastmesseinheit', label:'Lastmesseinheit (√úber-/Unterlast) ‚Äì Test', fields:[{type:'status'},{type:'note'}]},
      {id:'sensorik', label:'Sicherheitsrelevante Sensorik / Lichtschranken', fields:[{type:'status'},{type:'note'}]},
      {id:'pruefbuch', label:'Pr√ºfbuch vorhanden und Eintrag vorgenommen', fields:[{type:'status'},{type:'note'}]},
      {id:'bedenken', label:'Bedenken gegen weiteren Betrieb', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'maengelliste', title:'M√§ngelliste', items:[
      {id:'maengel', label:'M√§ngel / Beanstandungen (Freitext)', fields:[{type:'note'}]},
      {id:'schmierstoffe', label:'Wurden die Schmierstoffe zur Verf√ºgung gestellt?', fields:[{type:'yesno'}]}
    ]}
  ];

  /* ---------------- Storage/State ---------------- */
  function lsGet(k,f){ try{return JSON.parse(localStorage.getItem(k))??f;}catch(e){return f;} }
  function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  const keyFor=(t)=>'serviceCheckDraft:last:'+t;

  let STATE = { header:{}, specs:{}, items:{}, protocolType:'rbg', datum_ddmmyyyy:null, dirty:false };
  let saveTimer=null;

  const $ = (s,el=document)=>el.querySelector(s);
  const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
  const pad=(n)=>String(n).padStart(2,'0');
  const toDDMMYYYY=(d)=> pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();

  function normalizeDateInput(s){
    if(!s) return null; s=String(s).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-'); return pad(+d)+'/'+pad(+m)+'/'+y; }
    s=s.replace(/[.\-]/g,'/');
    const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(m){ return pad(+m[1])+'/'+pad(+m[2])+'/'+m[3]; }
    return null;
  }
  const validDate=(s)=> !!normalizeDateInput(s);

  function debounceAutosave(){ if(saveTimer) clearTimeout(saveTimer); saveTimer=setTimeout(()=>{ lsSet(keyFor('rbg'), {header:STATE.header,specs:STATE.specs,items:STATE.items,datum_ddmmyyyy:STATE.datum_ddmmyyyy}); }, 250); }

  function loadAutosave(){
    const raw=lsGet(keyFor('rbg'), null);
    if(raw){ STATE.header=raw.header||{}; STATE.specs=raw.specs||{}; STATE.items=raw.items||{}; STATE.datum_ddmmyyyy=raw.datum_ddmmyyyy||toDDMMYYYY(new Date()); }
    else { STATE.header={}; STATE.specs={}; STATE.items={}; STATE.datum_ddmmyyyy=toDDMMYYYY(new Date()); }
    if(!STATE.header.datum){ STATE.header.datum=STATE.datum_ddmmyyyy; }
  }

  /* ---------------- Render ---------------- */
  function render(){
    const root=$('#content'); root.innerHTML='';

    const info=document.createElement('section'); info.className='card';
    info.innerHTML = \`<div class="banner \${validateReady()?'ok':'warn'}">\${validateReady() ? 'Pflichtfelder vollst√§ndig. Du kannst drucken/exportieren.' : 'Bitte Pflichtfelder (Projektnummer, Projekt, Betreiber, Datum) ausf√ºllen.'}</div>\`;
    root.appendChild(info);

    const head=document.createElement('section'); head.className='card';
    head.innerHTML='<h3 style="margin:6px 0 12px 0;font-size:16px;">Wartungsprotokoll ‚Äì Kopfbereich</h3>';
    const row=document.createElement('div'); row.className='row';
    HEADER_FIELDS.forEach(f=>{
      const wrap=document.createElement('div'); wrap.className='input'+(REQUIRED_HEADER_KEYS.includes(f.key)?' req':'');
      const lab=document.createElement('label'); lab.textContent=f.label;
      const inp=document.createElement('input');
      if(f.key==='datum'){
        inp.placeholder='TT/MM/JJJJ';
        inp.value=STATE.header.datum||STATE.datum_ddmmyyyy||toDDMMYYYY(new Date());
        inp.oninput=()=>{ const norm=normalizeDateInput(inp.value); if(norm){ inp.value=norm; STATE.header.datum=norm; STATE.datum_ddmmyyyy=norm; } else { STATE.header.datum=inp.value; } debounceAutosave(); updateFooter(); };
      }else{
        inp.placeholder=f.label; inp.value=STATE.header[f.key]||'';
        inp.oninput=()=>{ STATE.header[f.key]=inp.value; debounceAutosave(); updateFooter(); };
      }
      wrap.append(lab,inp); row.appendChild(wrap);
    });
    head.appendChild(row); root.appendChild(head);

    const tips=document.createElement('section'); tips.className='card';
    tips.innerHTML = '<details open><summary>‚ÑπÔ∏è Hinweise</summary><div class="note" style="margin-top:6px">Links/Rechts = Ansicht vom Schaltschrank Richtung Hubrahmen</div><div class="note">i.O. = in Ordnung ; n.i.O. = nicht in Ordnung ; n.v. = nicht vorhanden</div></details>';
    root.appendChild(tips);

    PROTOCOL_SECTIONS_RBG.forEach((s, i)=>{
      const c=document.createElement('section'); c.className='card';
      const det=document.createElement('details'); if(i<2) det.open = true;
      const sum=document.createElement('summary'); sum.textContent=s.title; det.appendChild(sum);

      s.items.forEach(item=>{
        const block=document.createElement('div'); block.style.margin='8px 0';
        const label=document.createElement('div'); label.style.fontWeight='600'; label.style.marginBottom='6px'; label.textContent=item.label;
        const toolrow=document.createElement('div'); toolrow.className='row';

        if((item.fields||[]).some(f=>f.type==='status')){
          const status=document.createElement('div'); status.className='badge';
          [{k:'io',t:'i.O.'},{k:'nio',t:'n.i.O.'},{k:'nv',t:'n.v.'}].forEach(opt=>{
            const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=opt.t;
            const cur=STATE.items[item.id]?.status; if(cur===opt.k) b.classList.add('active');
            b.addEventListener('click', ()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].status=opt.k; $$('.chip',status).forEach(x=>x.classList.remove('active')); b.classList.add('active'); debounceAutosave(); }, {passive:true});
            status.appendChild(b);
          });
          toolrow.appendChild(status);
        }

        (item.fields||[]).forEach(f=>{
          if(f.type==='measurement'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent=f.label+' ('+f.unit+')';
            const inp=document.createElement('input'); inp.type='number'; inp.inputMode='decimal'; inp.value=STATE.items[item.id]?.[f.label]||'';
            inp.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id][f.label]=inp.value; debounceAutosave(); };
            w.append(lab, inp); toolrow.appendChild(w);
          }
          if(f.type==='note'){
            const w=document.createElement('div'); w.className='input';
            const lab=document.createElement('label'); lab.textContent='Bemerkung';
            const ta=document.createElement('textarea'); ta.rows=2; ta.value=STATE.items[item.id]?.note||'';
            ta.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].note=ta.value; debounceAutosave(); };
            w.append(lab, ta); toolrow.appendChild(w);
          }
          if(f.type==='yesno'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent='Ja/Nein';
            const sel=document.createElement('select'); sel.innerHTML='<option value="">‚Äì</option><option>Ja</option><option>Nein</option>';
            sel.value=STATE.items[item.id]?.yesno||'';
            sel.onchange=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].yesno=sel.value; debounceAutosave(); };
            w.append(lab, sel); toolrow.appendChild(w);
          }
        });

        block.append(label, toolrow); det.appendChild(block);
      });

      c.appendChild(det); root.appendChild(c);
    });

    const footer=document.createElement('div'); footer.className='footer-actions';
    footer.innerHTML = '<span class="note">Alle √Ñnderungen werden lokal gespeichert.</span><span style="flex:1"></span><button class="primary" id="printBtn">Drucken / PDF</button>';
    root.appendChild(footer);
    $('#printBtn').onclick=()=>{ if(!validateReady()){ alert('Bitte Pflichtfelder ausf√ºllen (Projektnummer, Projekt, Betreiber, Datum).'); return; } window.print(); };
    updateFooter();
  }

  function validateReady(){
    for(const k of REQUIRED_HEADER_KEYS){
      const v=STATE.header[k];
      if(!v || !String(v).trim().length) return false;
      if(k==='datum' && !validDate(v)) return false;
    }
    return true;
  }
  function updateFooter(){ const b=$('#printBtn'); if(b) b.disabled=!validateReady(); }
  function validDate(s){ return !!normalizeDateInput(s); }

  /* ---------------- Init ---------------- */
  window.addEventListener('DOMContentLoaded', ()=>{
    document.body.classList.toggle('dark', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    loadAutosave();
    render();
    $('#toggleTheme').onclick=()=>document.body.classList.toggle('dark');
    $('#backBtn').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
  });
  </script>
</body>
</html>
