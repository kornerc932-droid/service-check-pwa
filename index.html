<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Check ‚Äì App</title>
  <style>
    :root { --bg:#f5f7fa; --fg:#1f2a34; --muted:#6b7b8c; --accent:#3b5a78; --card:#ffffff; --line:#d9e0e7; --ok:#1b8e3e; --warn:#c0392b; }
    body.dark { --bg:#0f1419; --fg:#e6ecf2; --muted:#9db0c2; --accent:#6aa0d1; --card:#1b242d; --line:#2a3642; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;}
    header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;}
    .title{display:flex;align-items:center;gap:8px}
    .title small{color:var(--muted);font-weight:500}
    .container{padding:16px;max-width:980px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px 12px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .input{flex:1;min-width:220px;display:flex;flex-direction:column;gap:6px}
    .input label{font-size:12px;color:var(--muted)}
    .req label::after{content:" *";color:#c0392b}
    .input input, .input textarea, .input select{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;color:#111}
    body.dark .input input, body.dark .input textarea, body.dark .input select{background:#0e1419;color:#e6ecf2;border-color:#2a3642}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .tile{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;cursor:pointer;display:flex;flex-direction:column;gap:8px}
    .tile:hover{outline:2px solid var(--accent);}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button.primary{background:var(--accent);border:none;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
    button.ghost{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer}
    button.icon{padding:8px 10px}
    button[disabled]{opacity:0.5;cursor:not-allowed}
    .note{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .printOnly{display:none}
    .sig-pad{border:1px dashed var(--line); border-radius:8px; padding:8px}
    .sig-canvas{width:100%; height:160px; background:#fff; border:1px solid var(--line); border-radius:6px; touch-action: none;}
    .sig-tools{display:flex; gap:8px; margin-top:6px;}
    .checkbox{display:flex; align-items:center; gap:6px; font-size:14px;}
    .banner{border:1px solid var(--line); background:#fff3; padding:10px 12px; border-radius:10px}
    .banner.ok{border-color:#bfe6cc;background:#ecfff1;color:var(--ok)}
    .banner.warn{border-color:#f4c7c7;background:#fff0f0;color:var(--warn)}
    .footer-actions{position:sticky;bottom:0;background:var(--bg);border-top:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;flex-wrap:wrap}
    a.link{color:inherit}
    @media print{
      header, .toolbar, .footer-actions, .banner, .startOnly, .authOnly, .homeOnly, .specsOnly { display:none !important; }
      .printOnly{display:block}
      body{background:#fff;color:#000}
      .container{max-width:none;margin:0;padding:0}
      .card{break-inside:avoid;border:1px solid #999}
      .input input, .input textarea{border:1px solid #999}
      @page { size: A4 portrait; margin: 12mm; }
    }
    /* Einstellungen Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:1000}
    .modal.open{display:flex}
    .modal-card{background:var(--card);border:1px solid var(--line);border-radius:12px;max-width:800px;width:92%;padding:12px}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <button class="ghost icon" id="backBtn" title="Zur√ºck">‚¨ÖÔ∏è</button>
      <h1 id="appTitle">Service Check</h1>
      <small id="subtitle"></small>
    </div>
    <div class="toolbar">
      <button class="ghost icon" id="toggleTheme" title="Hell/Dunkel">üåó</button>
      <button class="ghost icon" id="settingsBtn" title="Einstellungen">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="container" id="content"></main>

  <!-- Einstellungen Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px 0;font-size:16px;">Einstellungen</h2>
        <button class="ghost icon" id="closeSettings">‚úñÔ∏è</button>
      </div>
      <div class="note" style="margin-bottom:8px">Pflichtfelder mit * ‚Äì erforderlich zum Drucken/Export.</div>
      <div id="settingsForm"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="ghost" id="settingsSave">Speichern</button>
      </div>
    </div>
  </div>

<script>
  // ---------------- CONFIG ----------------
  const REQUIRED_HEADER_KEYS = ['projekt','anlagenteil','datum','durchfuehrender'];
  const HEADER_FIELDS = [
    {key:'projekt', label:'Projekt'},
    {key:'anlagenteil', label:'Anlagenteil'},
    {key:'datum', label:'Datum (TT/MM/JJJJ)'},
    {key:'betriebsstunden', label:'Betriebsstunden'},
    {key:'durchfuehrender', label:'Durchf√ºhrender'},
    {key:'auftragsnummer', label:'Auftragsnummer', optional:true},
    {key:'betreiber', label:'Betreiber', optional:true}
  ];

  // RBG Protokoll (dein bisheriges, angepasst)
  const PROTOCOL_SECTIONS_RBG = [
    { id:'gasse', title:'Gasse / Ausr√ºstung', items:[
      {id:'schleifleitung', label:'Schleifleitung / Stromabnehmer', fields:[{type:'status'},{type:'note'}]},
      {id:'fahrschiene', label:'Fahrschiene (Befestigung/Tragbild)', fields:[{type:'status'},{type:'note'}]},
      {id:'oberfuehrung', label:'Obere F√ºhrungsschiene (Befestigung, Verbindungen)', fields:[{type:'status'},{type:'note'}]},
      {id:'puffer', label:'Puffer / Festanschl√§ge (Befestigung)', fields:[{type:'status'},{type:'note'}]}
    ]},

    { id:'fahrwagen', title:'Fahrwagen / F√ºhrungsrollen / Laufr√§der', items:[
      {id:'fw_befestigung', label:'Fahrwerk ‚Äì Befestigung', fields:[{type:'status'},{type:'note'}]},
      {id:'fw_motor', label:'Fahrwerk ‚Äì Motor', fields:[{type:'status'},{type:'note'}]},
      {id:'fw_drehmomentstuetze', label:'Fahrwerk ‚Äì Drehmomentst√ºtze', fields:[{type:'status'},{type:'note'}]},

      {id:'fr_hl', label:'F√ºhrungsrolle Fahrwagen hinten links', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_hr', label:'F√ºhrungsrolle Fahrwagen hinten rechts', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_vl', label:'F√ºhrungsrolle Fahrwagen vorn links', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},
      {id:'fr_vr', label:'F√ºhrungsrolle Fahrwagen vorn rechts', fields:[{type:'status'},{type:'measurement',label:'Spaltma√ü',unit:'mm'},{type:'note'}]},

      {id:'lr_angetrieben', label:'Laufrad angetrieben', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'note'}]},
      {id:'lr_nichtangetrieben', label:'Laufrad nicht angetrieben', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'note'}]}
    ]},

    { id:'hubwerk', title:'Hubwerk', items:[
      {id:'befestigungen_allg', label:'Befestigungen (allg.)', fields:[{type:'status'},{type:'note'}]},
      {id:'als_bremse', label:'Bremse ‚Äì Arbeitsluftspalt (nach Herstellervorgabe)', fields:[{type:'status'},{type:'measurement',label:'ALS',unit:'mm'},{type:'note'}]},
      {id:'oeldichtheit', label:'Dichtungen / √ñldichtheit', fields:[{type:'status'},{type:'note'}]},

      {id:'hubseil', label:'Hubseil ‚Äì Sichtpr√ºfung (ISO 4309), Ablegereife', fields:[{type:'status'},{type:'measurement',label:'Seildicke',unit:'mm'},{type:'note'}]},

      {id:'seiltrommel_rillung', label:'Seiltrommel ‚Äì Seilrillung kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'seiltrommel_lagerung', label:'Seiltrommel ‚Äì Lagerung nachschmieren', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},

      {id:'uml_kopftraverse', label:'Seilumlenkrollen ‚Äì Kopftraverse (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_kopftraverse_vorne', label:'Seilumlenkrollen ‚Äì Kopftraverse vorne (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},
      {id:'uml_hubrahmen', label:'Seilumlenkrollen ‚Äì Hubrahmen (Einlauftiefe pr√ºfen, nachschmieren)', fields:[{type:'status'},{type:'measurement',label:'Einlauftiefe',unit:'mm'},{type:'lubricated'},{type:'note'}]},

      {id:'energiekette', label:'Energiekette/Schleifleitung ‚Äì Besch√§digungen kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'energiekette_uebergaenge', label:'Energiekette/Schleifleitung ‚Äì √úberg√§nge kontrollieren', fields:[{type:'status'},{type:'note'}]},
      {id:'energiekette_festpunkte', label:'Energiekette/Schleifleitung ‚Äì Festpunkte Festsitz pr√ºfen', fields:[{type:'status'},{type:'note'}]}
    ]},

    { id:'tisch_kette_antrieb', title:'Teleskoptisch / Kettensystem / Antrieb', items:[
      {id:'oberteilauflage', label:'Oberteilauflage', fields:[{type:'status'},{type:'note'}]},
      {id:'kurvenrollen', label:'Kurvenrollen', fields:[{type:'status'},{type:'note'}]},
      {id:'schleifleisten', label:'Schleifleisten (einstellen falls n√∂tig)', fields:[{type:'status'},{type:'note'}]},
      {id:'zahnstange', label:'Zahnstange / Rollen / Gleitleisten', fields:[{type:'status'},{type:'note'}]},
      {id:'stuetzrollen', label:'St√ºtzrollen', fields:[{type:'status'},{type:'note'}]},
      {id:'getriebe', label:'Getriebe', fields:[{type:'status'},{type:'note'}]},
      {id:'ketten', label:'Ketten ‚Äì nachspannen & schmieren', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'kettenspanner', label:'Kettenspanner', fields:[{type:'status'},{type:'note'}]},
      {id:'umlenkrollen_ketten', label:'Umlenkrollen / Kettenr√§der', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'kupplung', label:'Kupplung', fields:[{type:'status'},{type:'note'}]},
      {id:'gelenkwelle', label:'Gelenkwelle', fields:[{type:'status'},{type:'note'}]}
    ]},

    { id:'wiederkehrende_pruefung', title:'Wiederkehrende Pr√ºfung (Sicherheit)', items:[
      {id:'notauskette', label:'Not-Aus-Kette inkl. Verriegelungen ‚Äì Funktionspr√ºfung', fields:[{type:'status'},{type:'note'}]},
      {id:'endpositionen', label:'Endpositionen Wartung/Semiautomatik anfahren', fields:[{type:'status'},{type:'note'}]},
      {id:'bremsweg', label:'Bremsweg (ohne Last, niedrige Geschwindigkeit)', fields:[{type:'status'},{type:'note'}]},
      {id:'fangsystem', label:'Fangsystem / Geschwindigkeitsbegrenzer / Gest√§nge', fields:[{type:'status'},{type:'note'}]},
      {id:'lastmesseinheit', label:'Lastmesseinheit (√úber-/Unterlast) ‚Äì Test', fields:[{type:'status'},{type:'note'}]},
      {id:'sensorik', label:'Sicherheitsrelevante Sensorik / Lichtschranken', fields:[{type:'status'},{type:'note'}]},
      {id:'pruefbuch', label:'Pr√ºfbuch vorhanden und Eintrag vorgenommen', fields:[{type:'status'},{type:'note'}]},
      {id:'bedenken', label:'Bedenken gegen weiteren Betrieb', fields:[{type:'status'},{type:'note'}]}
    ]},

    { id:'maengelliste', title:'M√§ngelliste', items:[
      {id:'maengel', label:'M√§ngel / Beanstandungen (Freitext)', fields:[{type:'note'}]},
      {id:'schmierstoffe', label:'Wurden die Schmierstoffe zur Verf√ºgung gestellt?', fields:[{type:'yesno'}]}
    ]}
  ];

  // Beispiel-Abschnitte f√ºr F√∂rdertechnik (erweiterbar)
  const PROTOCOL_SECTIONS_FT = [
    { id:'antrieb', title:'Antriebsstation', items:[
      {id:'ft_motor', label:'Motor / Getriebe', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_gek', label:'Kettenspanner / Riemenspannung', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'ft_schutz', label:'Schutzabdeckungen', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'umlenk', title:'Umlenkstation', items:[
      {id:'ft_rollen', label:'Umlenkrollen / Lager', fields:[{type:'status'},{type:'lubricated'},{type:'note'}]},
      {id:'ft_festigkeit', label:'Befestigungen', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'strecke', title:'F√∂rderstrecke', items:[
      {id:'ft_bahnen', label:'Rollen / B√§nder / Ketten', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_sens', label:'Sensorik / Lichtschranken', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_kabel', label:'Energief√ºhrung / Kabel / √úberg√§nge', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'sicherheit', title:'Sicherheit', items:[
      {id:'ft_notaus', label:'Not-Aus / Verriegelungen', fields:[{type:'status'},{type:'note'}]},
      {id:'ft_betrieb', label:'Bedenken gegen Betrieb', fields:[{type:'status'},{type:'note'}]}
    ]},
    { id:'maengel', title:'M√§ngelliste', items:[
      {id:'ft_maengel', label:'M√§ngel / Beanstandungen (Freitext)', fields:[{type:'note'}]},
      {id:'ft_schmierstoffe', label:'Wurden die Schmierstoffe zur Verf√ºgung gestellt?', fields:[{type:'yesno'}]}
    ]}
  ];

  const PROTOCOLS = {
    rbg: {
      name: 'Regalbedienger√§t',
      specs: [
        {key:'mast', label:'Mast', type:'select', options:['Ein-Mast','Zwei-Mast']},
        {key:'teleskoptisch', label:'Teleskoptisch', type:'select', options:['einfach','doppelt']},
        {key:'nutzlast', label:'Nutzlast (kg)', type:'number'},
        {key:'hubhoehe', label:'max. Hubh√∂he (m)', type:'number'},
        {key:'fahrweg', label:'Fahrweg (m)', type:'number'}
      ],
      sections: PROTOCOL_SECTIONS_RBG
    },
    ft: {
      name: 'F√∂rdertechnik',
      specs: [
        {key:'system', label:'System', type:'select', options:['Rollenbahn','Gurtf√∂rderer','Kettenf√∂rderer','Heber','Drehtisch']},
        {key:'antrieb', label:'Antrieb', type:'select', options:['Motor / Getriebe','Direktantrieb']},
        {key:'spurbreite', label:'Spurbreite (mm)', type:'number'},
        {key:'geschwindigkeit', label:'F√∂rdergeschwindigkeit (m/s)', type:'number'}
      ],
      sections: PROTOCOL_SECTIONS_FT
    },
    other: {
      name: 'Andere Anlage',
      specs: [
        {key:'beschreibung', label:'Kurzbeschreibung', type:'text'},
        {key:'hersteller', label:'Hersteller (optional)', type:'text'}
      ],
      sections: [
        { id:'allg', title:'Allgemein', items:[
          {id:'all_bef', label:'Befestigungen', fields:[{type:'status'},{type:'note'}]},
          {id:'all_sens', label:'Sensorik', fields:[{type:'status'},{type:'note'}]}
        ]},
        { id:'sich', title:'Sicherheit', items:[
          {id:'all_not', label:'Not-Aus', fields:[{type:'status'},{type:'note'}]}
        ]},
        { id:'mgl', title:'M√§ngelliste', items:[
          {id:'all_m', label:'M√§ngel (Freitext)', fields:[{type:'note'}]}
        ]}
      ]
    }
  };

  // ---------------- STATE ----------------
  let STATE = {
    user: null, // {name, email, pin} ‚Äì lokal
    header: {}, // Kopfdaten ‚Üí Einstellungen
    specs: {},  // pro Anlage
    protocolType: null, // 'rbg' | 'ft' | 'other'
    items: {},  // Protokoll-Felder
    signatures: {sig1:null, sig2:null},
    datum_ddmmyyyy: null,
    page: 'start'
  };
  let saveTimer=null;

  // ---------------- HELPERS ----------------
  const $ = (sel, el=document)=>el.querySelector(sel);
  const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
  const pad=(n)=>String(n).padStart(2,'0');
  const toDDMMYYYY=(d)=> pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();
  const validDate=(s)=> /^\d{2}\/\d{2}\/\d{4}$/.test(s);

  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#1f2a34',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:'9999',fontSize:'13px'});
    document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
  }

  function keyFor(type){ return 'serviceCheckDraft:'+type; }
  function saveState(){
    localStorage.setItem('serviceCheckUser', JSON.stringify(STATE.user||{}));
    const p = STATE.protocolType || 'default';
    localStorage.setItem(keyFor(p), JSON.stringify({
      header: STATE.header, specs: STATE.specs, items: STATE.items, signatures: STATE.signatures, datum_ddmmyyyy: STATE.datum_ddmmyyyy
    }));
    toast('Gespeichert');
  }
  function debounceSave(){ if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(saveState, 400); }

  function loadState(){
    try{ const u=JSON.parse(localStorage.getItem('serviceCheckUser')||'null'); if(u && u.name) STATE.user=u; }catch(e){}
    const p = STATE.protocolType || 'rbg';
    try{
      const raw=localStorage.getItem(keyFor(p));
      if(raw){
        const obj=JSON.parse(raw);
        STATE.header=obj.header||{};
        STATE.specs=obj.specs||{};
        STATE.items=obj.items||{};
        STATE.signatures=obj.signatures||{sig1:null,sig2:null};
        STATE.datum_ddmmyyyy=obj.datum_ddmmyyyy||toDDMMYYYY(new Date());
      } else {
        // Defaults
        STATE.header={};
        STATE.items={};
        STATE.specs={};
        STATE.signatures={sig1:null,sig2:null};
        STATE.datum_ddmmyyyy=toDDMMYYYY(new Date());
        STATE.header.datum = STATE.datum_ddmmyyyy;
      }
    }catch(e){}
  }

  function clearDraft(){
    if(!STATE.protocolType) return;
    localStorage.removeItem(keyFor(STATE.protocolType));
    loadState(); render();
  }

  // ---------------- NAV ----------------
  function setTitle(title, subtitle=''){
    $('#appTitle').textContent = title || 'Service Check';
    $('#subtitle').textContent = subtitle ? '¬∑ '+subtitle : '';
  }
  function navigate(page){
    STATE.page = page;
    render();
  }

  // ---------------- UI RENDERERS ----------------
  function render(){
    const root = $('#content'); root.innerHTML='';
    // top controls visibility
    $('#backBtn').style.display = (STATE.page==='start'||STATE.page==='home') ? 'none' : 'inline-flex';
    $('#settingsBtn').style.display = (STATE.page==='protocol'||STATE.page==='home'||STATE.page==='specs') ? 'inline-flex' : 'none';

    if(STATE.page==='start'){ renderStart(root); return; }
    if(STATE.page==='auth'){ renderAuth(root); return; }
    if(STATE.page==='home'){ renderHome(root); return; }
    if(STATE.page==='specs'){ renderSpecs(root); return; }
    if(STATE.page==='protocol'){ renderProtocol(root); return; }
  }

  function renderStart(root){
    setTitle('Service Check','Start');
    const card=document.createElement('section'); card.className='card';
    card.innerHTML=`
      <h2 style="margin:6px 0 12px 0;font-size:16px;">Willkommen</h2>
      <p>Diese App speichert Daten lokal (offline). F√ºr Team-Funktionen/Cloud sp√§ter.</p>
      <div class="row startOnly">
        <button class="primary" id="startAuth">Anmelden / Registrieren</button>
        <button class="ghost" id="skipToHome">Ohne Anmeldung fortfahren</button>
      </div>
    `;
    root.appendChild(card);
    $('#startAuth').onclick=()=>navigate('auth');
    $('#skipToHome').onclick=()=>{ if(!STATE.user){ STATE.user={name:'Gast'}; } navigate('home'); };
  }

  function renderAuth(root){
    setTitle('Service Check','Anmeldung');
    const card=document.createElement('section'); card.className='card';
    const name=STATE.user?.name||''; const email=STATE.user?.email||'';
    card.innerHTML=`
      <div class="row authOnly">
        <div class="input req"><label>Dein Name</label><input id="name" placeholder="Name" value="${name}"></div>
        <div class="input"><label>E-Mail (optional)</label><input id="email" placeholder="email@example.com" value="${email}"></div>
        <div class="input req"><label>PIN (4-stellig, lokal)</label><input id="pin" inputmode="numeric" maxlength="4" placeholder="****"></div>
      </div>
      <div class="note">Hinweis: Die Anmeldung ist <b>lokal</b> (nur auf diesem Ger√§t). Kein Server.</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="primary" id="doLogin">Weiter</button>
      </div>
    `;
    root.appendChild(card);
    $('#doLogin').onclick=()=>{
      const n=$('#name').value.trim(); const p=$('#pin').value.trim();
      if(!n || p.length!==4){ alert('Bitte Name und 4-stellige PIN eingeben.'); return; }
      STATE.user={name:n, email:$('#email').value.trim()||undefined, pin:p};
      saveState(); navigate('home');
    };
  }

  function renderHome(root){
    setTitle('Service Check','Hauptmen√º');
    const card=document.createElement('section'); card.className='card';
    card.innerHTML=`
      <div class="note homeOnly">Angemeldet als: <b>${STATE.user?.name||'Gast'}</b></div>
      <h2 style="margin:6px 0 12px 0;font-size:16px;">Was m√∂chtest du pr√ºfen?</h2>
      <div class="grid" id="tiles"></div>
    `;
    root.appendChild(card);
    const grid=$('#tiles');
    Object.entries(PROTOCOLS).forEach(([k,v])=>{
      const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<div style="font-weight:600">${v.name}</div><div class="note">Neues Protokoll erstellen</div>`;
      t.onclick=()=>{ STATE.protocolType=k; loadState(); navigate('specs'); };
      grid.appendChild(t);
    });
  }

  function renderSpecs(root){
    const proto = PROTOCOLS[STATE.protocolType];
    setTitle('Service Check', proto.name+' ¬∑ Spezifikation');
    const card=document.createElement('section'); card.className='card';
    const wrap=document.createElement('div'); wrap.className='row specsOnly';
    proto.specs.forEach(f=>{
      const box=document.createElement('div'); box.className='input';
      const lab=document.createElement('label'); lab.textContent=f.label;
      let field;
      if(f.type==='select'){
        field=document.createElement('select');
        field.innerHTML = '<option value="">‚Äì</option>' + f.options.map(o=>`<option>${o}</option>`).join('');
        field.value = STATE.specs[f.key] || '';
        field.onchange=()=>{ STATE.specs[f.key]=field.value; debounceSave(); };
      } else {
        field=document.createElement('input'); field.type=f.type||'text';
        field.value = STATE.specs[f.key]||'';
        field.oninput=()=>{ STATE.specs[f.key]=field.value; debounceSave(); };
      }
      box.append(lab, field); wrap.appendChild(box);
    });
    card.appendChild(wrap);
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
    const next=document.createElement('button'); next.className='primary'; next.textContent='Weiter zum Protokoll';
    next.onclick=()=>navigate('protocol');
    actions.appendChild(next);
    card.appendChild(actions);
    root.appendChild(card);
  }

  // -------- PROTOKOLL --------
  function renderProtocol(root){
    const proto = PROTOCOLS[STATE.protocolType];
    setTitle('Service Check', proto.name+' ¬∑ Protokoll');

    // Hinweise / Status
    const infoCard=document.createElement('section'); infoCard.className='card';
    const ready = validateRequiredHeadersOnly();
    infoCard.innerHTML = `
      <div class="banner ${ready?'ok':'warn'}">
        ${ready ? 'Pflichtfelder in Einstellungen vollst√§ndig.' : 'Bitte Pflichtfelder in den Einstellungen ausf√ºllen, um Drucken/Export zu aktivieren.'}
      </div>
      <details style="margin-top:8px">
        <summary>‚ÑπÔ∏è Hinweise anzeigen/ausblenden</summary>
        <div class="details">
          <div class="note" style="margin-bottom:6px;">Links/Rechts = Ansicht vom Schaltschrank Richtung Hubrahmen</div>
          <div class="note">i.O. = in Ordnung ; Fehler = Mangel ; n.v. = nicht vorhanden</div>
        </div>
      </details>
    `;
    root.appendChild(infoCard);

    // SPEZIFIKATION kompakt darstellen
    const specCard=document.createElement('section'); specCard.className='card';
    specCard.innerHTML='<h2 style="margin:6px 0 12px 0;font-size:16px;">Spezifikation</h2>';
    const srow=document.createElement('div'); srow.className='row';
    PROTOCOLS[STATE.protocolType].specs.forEach(f=>{
      const val = STATE.specs[f.key] || '‚Äì';
      const div=document.createElement('div'); div.className='input'; div.innerHTML=`<label>${f.label}</label><input disabled value="${val}">`;
      srow.appendChild(div);
    });
    specCard.appendChild(srow);
    root.appendChild(specCard);

    // ABSCHNITTE
    const sectionsWrap=document.createElement('div'); sectionsWrap.id='sections';
    root.appendChild(sectionsWrap);
    renderSectionsInto(sectionsWrap, proto.sections);

    // SIGNATUREN
    const sigCard=document.createElement('section'); sigCard.className='card';
    sigCard.innerHTML='<h2 style="margin:6px 0 12px 0;font-size:16px;">Unterschriften</h2>';
    const sigRow=document.createElement('div'); sigRow.className='row';
    sigRow.appendChild(signatureBlock('Pr√ºfer','sig1'));
    sigRow.appendChild(signatureBlock('Kunde','sig2'));
    const dateBox=document.createElement('div'); dateBox.className='input'; dateBox.innerHTML=`<label>Datum (TT/MM/JJJJ)</label><input id="sigDate" placeholder="TT/MM/JJJJ">`;
    sigRow.appendChild(dateBox);
    sigCard.appendChild(sigRow);
    root.appendChild(sigCard);
    const sd = $('#sigDate'); const nowFmt = toDDMMYYYY(new Date()); sd.value = STATE.header['datum_unterschrift'] || nowFmt;
    sd.oninput = ()=>{ STATE.header['datum_unterschrift'] = sd.value; debounceSave(); };

    // FOOTER ACTIONS
    const footer=document.createElement('div'); footer.className='footer-actions';
    footer.innerHTML=`
      <button class="ghost" id="save">Speichern</button>
      <button class="ghost" id="export">Export (JSON)</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        Import <input id="import" type="file" accept="application/json" style="display:none">
      </label>
      <button class="ghost" id="clear">Entwurf l√∂schen</button>
      <span style="flex:1"></span>
      <button class="primary" id="print" disabled>Drucken / PDF</button>
    `;
    root.appendChild(footer);

    function updateFooterActions(){
      const ok = validateRequiredHeadersOnly();
      $('#print').disabled = !ok;
    }
    updateFooterActions();

    // events
    $('#save').onclick=saveState;
    $('#export').onclick=()=>{
      const blob = new Blob([JSON.stringify({
        header: STATE.header, specs: STATE.specs, items: STATE.items, protocolType: STATE.protocolType
      },null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='service_check_export.json'; a.click(); URL.revokeObjectURL(url);
    };
    $('#import').addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{ try{ const o=JSON.parse(r.result);
          STATE.header=o.header||STATE.header;
          STATE.specs=o.specs||STATE.specs;
          STATE.items=o.items||STATE.items;
          STATE.protocolType=o.protocolType||STATE.protocolType;
          saveState(); render();
        }catch(err){ alert('Ung√ºltige JSON-Datei.'); } };
      r.readAsText(f);
    });
    $('#clear').onclick=()=>{ if(confirm('Entwurf wirklich l√∂schen?')) clearDraft(); };
    $('#print').onclick=()=>{
      if(!validateRequiredHeadersOnly()){ alert('Bitte Pflichtfelder in den Einstellungen ausf√ºllen.'); return; }
      window.print();
    };

    // observer, falls im Einstellungs-Modal ge√§ndert
    window._updateFooterActions = updateFooterActions;
  }

  function signatureBlock(labelText,key){
    const wrap=document.createElement('div'); wrap.className='input sig-pad';
    const lab=document.createElement('label'); lab.textContent='Unterschrift '+labelText;
    const canvas=document.createElement('canvas'); canvas.id='cv_'+key; canvas.className='sig-canvas';
    const tools=document.createElement('div'); tools.className='sig-tools';
    const clear=document.createElement('button'); clear.className='ghost'; clear.textContent='L√∂schen';
    tools.appendChild(clear);
    wrap.append(lab, canvas, tools);
    setTimeout(()=>signaturePad(canvas.id, clear, key), 0);
    return wrap;
  }

  // Render sections/items
  function renderSectionsInto(container, sections){
    sections.forEach(section=>{
      const card=document.createElement('section'); card.className='card';
      const details=document.createElement('details');
      const summary=document.createElement('summary'); summary.textContent=section.title;
      details.appendChild(summary);

      section.items.forEach(item=>{
        const wrap=document.createElement('div'); wrap.className='details';
        const label=document.createElement('div'); label.textContent=item.label; label.style.marginBottom='6px'; label.style.fontWeight='500';
        const tools=document.createElement('div'); tools.className='row';

        const hasStatus = (item.fields||[]).some(f=>f.type==='status');
        if(hasStatus){
          const status=document.createElement('div'); status.className='badge';
          [{k:'io',t:'i.O.'},{k:'fehler',t:'Fehler'},{k:'nv',t:'n.v.'}].forEach(opt=>{
            const b=document.createElement('button'); b.className='chip'; b.textContent=opt.t;
            const cur=STATE.items[item.id]?.status; if(cur===opt.k) b.classList.add('active');
            b.onclick=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].status=opt.k; $$('.chip',status).forEach(x=>x.classList.remove('active')); b.classList.add('active'); debounceSave(); };
            status.appendChild(b);
          });
          tools.appendChild(status);
        }

        (item.fields||[]).forEach(f=>{
          if(f.type==='note'){
            const w=document.createElement('div'); w.className='input'; w.style.minWidth='260px';
            const lab=document.createElement('label'); lab.textContent='Bemerkung';
            const ta=document.createElement('textarea'); ta.rows=2; ta.value=STATE.items[item.id]?.note||'';
            ta.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].note=ta.value; debounceSave(); };
            w.append(lab, ta); tools.appendChild(w);
          }
          if(f.type==='measurement'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='180px';
            const lab=document.createElement('label'); lab.textContent=f.label+' ('+f.unit+')';
            const inp=document.createElement('input'); inp.type='number'; inp.value=STATE.items[item.id]?.[f.label]||'';
            inp.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id][f.label]=inp.value; debounceSave(); };
            w.append(lab, inp); tools.appendChild(w);
          }
          if(f.type==='yesno'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='180px';
            const lab=document.createElement('label'); lab.textContent='Ja/Nein';
            const sel=document.createElement('select'); sel.innerHTML='<option value="">‚Äì</option><option>Ja</option><option>Nein</option>';
            sel.value=STATE.items[item.id]?.yesno||'';
            sel.onchange=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].yesno=sel.value; debounceSave(); };
            w.append(lab, sel); tools.appendChild(w);
          }
          if(f.type==='date'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent=f.label;
            const inp=document.createElement('input'); inp.type='date'; inp.value=STATE.items[item.id]?.[f.label]||'';
            inp.oninput=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id][f.label]=inp.value; debounceSave(); };
            w.append(lab, inp); tools.appendChild(w);
          }
          if(f.type==='lubricated'){
            const w=document.createElement('div'); w.className='input'; w.style.maxWidth='200px';
            const lab=document.createElement('label'); lab.textContent='';
            const box=document.createElement('div'); box.className='checkbox';
            const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!STATE.items[item.id]?.geschmiert;
            const span=document.createElement('span'); span.textContent='geschmiert';
            cb.onchange=()=>{ STATE.items[item.id]=STATE.items[item.id]||{}; STATE.items[item.id].geschmiert=cb.checked; debounceSave(); };
            box.append(cb, span); w.append(lab, box); tools.appendChild(w);
          }
        });

        // Foto
        const photoWrap=document.createElement('div'); photoWrap.className='input'; photoWrap.style.maxWidth='260px';
        const photoLab=document.createElement('label'); photoLab.textContent='Foto (optional)';
        const photo=document.createElement('input'); photo.type='file'; photo.accept='image/*;capture=camera';
        const preview=document.createElement('img'); preview.style.maxWidth='120px'; preview.style.border='1px solid var(--line)'; preview.style.borderRadius='6px'; preview.style.marginTop='6px';
        if(STATE.items[item.id]?.photo){ preview.src=STATE.items[item.id].photo; photoWrap.appendChild(preview); }
        photo.onchange=async ()=>{ const f=photo.files?.[0]; if(!f) return;
          const b64=await fileToScaledDataURL(f,1600,0.75); STATE.items[item.id]=STATE.items[item.id]||{};
          STATE.items[item.id].photo=b64; preview.src=b64; if(!preview.parentNode) photoWrap.appendChild(preview); debounceSave(); };
        photoWrap.append(photoLab, photo); tools.appendChild(photoWrap);

        wrap.append(label, tools);
        details.appendChild(wrap);
      });

      card.appendChild(details);
      container.appendChild(card);
    });
  }

  // Image helper
  function fileToScaledDataURL(file, maxSide=1600, quality=0.75){
    return new Promise((resolve)=>{
      const r=new FileReader();
      r.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          let w=img.width,h=img.height;
          if(w>h && w>maxSide){ h=Math.round(h*maxSide/w); w=maxSide; }
          else if(h>maxSide){ w=Math.round(w*maxSide/h); h=maxSide; }
          const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
          const cx=cv.getContext('2d'); cx.drawImage(img,0,0,w,h);
          resolve(cv.toDataURL('image/jpeg', quality));
        };
        img.src=r.result;
      };
      r.readAsDataURL(file);
    });
  }

  // Signature pad
  function signaturePad(canvasId, clearBtn, key){
    const canvas=document.getElementById(canvasId);
    const ctx=canvas.getContext('2d');
    function resize(){
      const ratio=Math.max(window.devicePixelRatio||1,1);
      const rect=canvas.getBoundingClientRect();
      canvas.width=rect.width*ratio; canvas.height=rect.height*ratio;
      ctx.scale(ratio,ratio); ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#111';
      if(STATE.signatures[key]){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,rect.width,rect.height); img.src=STATE.signatures[key]; }
    }
    let drawing=false,lastX=0,lastY=0;
    function start(x,y){ drawing=true; lastX=x; lastY=y; }
    function move(x,y){ if(!drawing) return; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke(); lastX=x; lastY=y; }
    function end(){ drawing=false; STATE.signatures[key]=canvas.toDataURL('image/png'); debounceSave(); }
    function getPos(e){ const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
    window.addEventListener('resize',resize);
    resize();
    canvas.addEventListener('mousedown', e=>{const p=getPos(e); start(p.x,p.y);});
    canvas.addEventListener('mousemove', e=>{const p=getPos(e); move(p.x,p.y);});
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', e=>{const p=getPos(e); start(p.x,p.y); e.preventDefault();});
    canvas.addEventListener('touchmove', e=>{const p=getPos(e); move(p.x,p.y); e.preventDefault();});
    canvas.addEventListener('touchend', end);
    clearBtn.onclick=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); STATE.signatures[key]=null; debounceSave(); };
  }

  // ---------------- Einstellungen (Modal) ----------------
  function openSettings(){
    // build form
    const box = $('#settingsForm'); box.innerHTML='';
    const row = document.createElement('div'); row.className='row';
    HEADER_FIELDS.forEach(f=>{
      const w=document.createElement('div'); w.className='input'+(REQUIRED_HEADER_KEYS.includes(f.key)?' req':'');
      const lab=document.createElement('label'); lab.textContent=f.label;
      const inp=document.createElement('input'); inp.placeholder=f.label;
      if(f.key==='datum'){
        inp.type='text'; inp.inputMode='numeric'; inp.maxLength=10; inp.placeholder='TT/MM/JJJJ';
        inp.value=STATE.datum_ddmmyyyy || toDDMMYYYY(new Date());
        inp.oninput=()=>{ let v=inp.value.replace(/[^0-9]/g,''); if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2); if(v.length>5) v=v.slice(0,5)+'/'+v.slice(5,9);
          inp.value=v; STATE.header.datum=v; STATE.datum_ddmmyyyy=v; debounceSave(); maybeUpdateFooter(); };
        inp.onblur=()=>{ if(!validDate(inp.value)) alert('Bitte Datum als TT/MM/JJJJ eingeben.'); };
      } else {
        inp.value=STATE.header[f.key]||'';
        inp.oninput=()=>{ STATE.header[f.key]=inp.value; debounceSave(); maybeUpdateFooter(); };
      }
      w.append(lab, inp); row.appendChild(w);
    });
    box.appendChild(row);
    $('#settingsModal').classList.add('open');
    $('#settingsModal').setAttribute('aria-hidden','false');
  }
  function closeSettings(){
    $('#settingsModal').classList.remove('open');
    $('#settingsModal').setAttribute('aria-hidden','true');
  }
  function validateRequiredHeadersOnly(){
    const missing = REQUIRED_HEADER_KEYS.filter(k => !(STATE.header[k] && String(STATE.header[k]).trim().length));
    if(missing.includes('datum') && !validDate(STATE.header['datum']||'')) return false;
    return missing.length===0;
  }
  function maybeUpdateFooter(){ if(typeof window._updateFooterActions==='function') window._updateFooterActions(); }

  // ---------------- INIT ----------------
  window.addEventListener('DOMContentLoaded', ()=>{
    document.body.classList.toggle('dark', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    // default auf RBG, damit Strukturen existieren
    STATE.protocolType='rbg';
    loadState();
    STATE.page = STATE.user ? 'home' : 'start';
    render();

    // Header buttons
    $('#toggleTheme').onclick=()=>document.body.classList.toggle('dark');
    $('#settingsBtn').onclick=openSettings;
    $('#closeSettings').onclick=closeSettings;
    $('#settingsSave').onclick=()=>{ saveState(); closeSettings(); maybeUpdateFooter(); };
    $('#backBtn').onclick=()=>{
      if(STATE.page==='auth'){ navigate('start'); return; }
      if(STATE.page==='home'){ navigate('start'); return; }
      if(STATE.page==='specs'){ navigate('home'); return; }
      if(STATE.page==='protocol'){ navigate('specs'); return; }
      navigate('start');
    };
  });
</script>
</body>
</html>
